<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.1"/>
    <title>fraud_detection API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#FN_PARAMETERS">FN_PARAMETERS</a>
            </li>
            <li>
                    <a class="function" href="#read_parameters_sheet">read_parameters_sheet</a>
            </li>
            <li>
                    <a class="variable" href="#filepaths">filepaths</a>
            </li>
            <li>
                    <a class="function" href="#summary_wrapper">summary_wrapper</a>
            </li>
            <li>
                    <a class="function" href="#check_ValueInRange">check_ValueInRange</a>
            </li>
            <li>
                    <a class="function" href="#check_CustomCondition">check_CustomCondition</a>
            </li>
            <li>
                    <a class="function" href="#check_ReverseCodedResponse">check_ReverseCodedResponse</a>
            </li>
            <li>
                    <a class="function" href="#check_SuspiciousCharacter">check_SuspiciousCharacter</a>
            </li>
            <li>
                    <a class="function" href="#check_SuspiciousName">check_SuspiciousName</a>
            </li>
            <li>
                    <a class="function" href="#check_IPLocation">check_IPLocation</a>
            </li>
            <li>
                    <a class="function" href="#check_LatLongLocation">check_LatLongLocation</a>
            </li>
            <li>
                    <a class="function" href="#check_MultipleIPAttempts">check_MultipleIPAttempts</a>
            </li>
            <li>
                    <a class="function" href="#check_BurstResponses">check_BurstResponses</a>
            </li>
            <li>
                    <a class="function" href="#check_DuplicatedText">check_DuplicatedText</a>
            </li>
            <li>
                    <a class="function" href="#decode_special_floats">decode_special_floats</a>
            </li>
            <li>
                    <a class="function" href="#flag_responses">flag_responses</a>
            </li>
            <li>
                    <a class="function" href="#classify_responses">classify_responses</a>
            </li>
            <li>
                    <a class="function" href="#print_flag_counts">print_flag_counts</a>
            </li>
            <li>
                    <a class="function" href="#print_classification_counts">print_classification_counts</a>
            </li>
            <li>
                    <a class="function" href="#plot_flag_cooccurrence_heatmap">plot_flag_cooccurrence_heatmap</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
fraud_detection    </h1>

                
                        <input id="mod-fraud_detection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-fraud_detection-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1">## Libraries</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">functools</span> <span class="c1"># Logging</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="c1">###########################</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="c1">##### BASIC FUNCTIONS #####</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="c1">###########################</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="c1">## Verify parameters file </span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="n">FN_PARAMETERS</span> <span class="o">=</span> <span class="s1">&#39;./config/parameters.xlsx&#39;</span>  <span class="c1"># Path to the parameters file</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">FN_PARAMETERS</span><span class="p">):</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameters file not found at &#39;</span><span class="si">{</span><span class="n">FN_PARAMETERS</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="k">def</span><span class="w"> </span><span class="nf">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">):</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">    Reads a specific worksheet from the parameters Excel file.</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">    Parameters:</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">        sheet_name (str): The name of the worksheet to read.</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    Returns:</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">        params (pd.DataFrame): DataFrame containing the sheet&#39;s contents.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="n">excel_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelFile</span><span class="p">(</span><span class="n">FN_PARAMETERS</span><span class="p">)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="k">if</span> <span class="n">sheet_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excel_file</span><span class="o">.</span><span class="n">sheet_names</span><span class="p">:</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>            <span class="sa">f</span><span class="s2">&quot;Worksheet &#39;</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&#39; not found in &#39;</span><span class="si">{</span><span class="n">FN_PARAMETERS</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>            <span class="sa">f</span><span class="s2">&quot;Available sheets: </span><span class="si">{</span><span class="n">excel_file</span><span class="o">.</span><span class="n">sheet_names</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="p">)</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">excel_file</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">)</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="c1">## Read file paths provided by the user</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="n">filepaths</span> <span class="o">=</span> <span class="n">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;filepaths&quot;</span><span class="p">)</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="c1">###################################</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="c1">##### FRAUD DETECTION METHODS #####</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="c1">###################################</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="k">def</span><span class="w"> </span><span class="nf">summary_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    Wrapper function to run a method, log execution time and flag summary,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    and handle exceptions gracefully without interrupting the pipeline.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    Parameters:</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">        func (function): The function to be wrapped.</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    Returns:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">        function: A wrapped version of the input function.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>  <span class="c1"># Preserve the name and docstring of the function</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="n">flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag&#39;</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="n">method_name</span> <span class="o">=</span> <span class="n">flag</span> <span class="k">if</span> <span class="n">flag</span> <span class="k">else</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>            <span class="c1"># Error handling for method</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>                    <span class="sa">f</span><span class="s2">&quot;The dataframe does not exist after executing &#39;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>                    <span class="sa">f</span><span class="s2">&quot;Make sure the corresponding parameters are correct.&quot;</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>                <span class="p">)</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="c1"># Flag summary</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of flagged responses for </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&#39; took </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR exeucting &#39;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&#39; took </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>    <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="c1">##### WITHIN RESPONSE CHECKS #####</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_ValueInRange</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">lower_threshold</span><span class="p">,</span> <span class="n">upper_threshold</span><span class="p">):</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">    Adds a flag column to the dataframe if the column value is within the threshold.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">    Parameters:</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant data.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        column_name (str) : Column name to check for threshold.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">        lower_threshold (float) : Values &gt;= lower threshold value are flagged.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">        upper_threshold (float) : Values &lt;= upper threshold value are flagged.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">    Returns:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with the flag.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lower_threshold</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper_threshold</span><span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_CustomCondition</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">    Adds a flag column to the dataframe based on the given boolean condition.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">    Parameters:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">        condition (str) : A Boolean condition written in Pandas evaluate expression format. </span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">            See https://pandas.pydata.org/docs/reference/api/pandas.eval.html for details.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">    Returns:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_ReverseCodedResponse</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">positive_columns</span><span class="p">,</span> <span class="n">negative_columns</span><span class="p">,</span> 
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>                              <span class="n">min_score</span><span class="p">,</span> <span class="n">max_score</span><span class="p">,</span> <span class="n">max_correlation</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">    Adds a flag column to the dataframe if the mean score of reverse-coded items is negatively correlated to the mean score of their counterparts.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">    The method normalizes the items based on min_score and max_score, and removes recoding artifacts (e.g., -99 for unanswered items). </span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">    This method can be applied to constructs that should be negatively correlated as well. </span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">    Parameters:</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">        df (pd.DataFrame) : DataFrame with relevant columns.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">        positive_columns (List[str]) : List of column names representing positive responses.</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        negative_columns (List[str]) : List of column names representing negative responses.</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        min_score (int) : Minimum possible score for the columns.</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        max_score (int) : Maximum possible score for the columns.</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        max_correlation (float) : Correlation above which the data is flagged.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">    Returns:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        df (pd.DataFrame) :Dataframe with the flag.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="c1"># Keeping valid responses within range and normalize score between -1 and 1</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>    <span class="n">normalize_score</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">min_score</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_score</span> <span class="o">-</span> <span class="n">min_score</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">positive_columns</span> <span class="o">+</span> <span class="n">negative_columns</span><span class="p">]</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>            <span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">normalize_score</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">min_score</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">max_score</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>    <span class="c1"># Find correlation between means</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>    <span class="n">mean_positives</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">positive_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>    <span class="n">mean_negatives</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">negative_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>    <span class="n">correlation</span> <span class="o">=</span> <span class="n">mean_positives</span> <span class="o">*</span> <span class="n">mean_negatives</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>    <span class="c1"># Positive correlation is suspicious between reverse coded items</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">correlation</span> <span class="o">&gt;=</span> <span class="n">max_correlation</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_SuspiciousCharacter</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">list_of_columns</span><span class="p">,</span> <span class="n">list_of_chars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;</span><span class="se">\xa0</span><span class="s2">&quot;</span><span class="p">]):</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">    Adds a flag column to the dataframe if there are suspicious characters (e.g., non-breaking character) in text response(s).</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">    Parameters:</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">        list_of_columns (List[str]) : List of column names with text responses.</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">        list_of_chars (List[str]) : List of suspicious characters to look for. Defaults to [&quot;\xa0&quot;].</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">            &quot;\xa0&quot;: ASCII for the non-breaking character.</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">    Returns:</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>    <span class="c1"># Convert missing data to empty string for character search</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>    <span class="n">list_of_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">list_of_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns being checked for Suspicious Characters: </span><span class="si">{</span><span class="n">list_of_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>    <span class="n">text_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">list_of_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>    <span class="n">text_df</span> <span class="o">=</span> <span class="n">text_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>    
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>    <span class="c1"># Check for all characters across all columns</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">text_df</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">list_of_chars</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_SuspiciousName</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_first_name</span><span class="p">,</span> <span class="n">column_last_name</span><span class="p">,</span> <span class="n">min_word_length</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">    Adds a flag column to the dataframe for suspicious response to first name and last name columns.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">    This flag only works if the first name and last name are collectde in two separate text responses. </span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">    A response is considered suspicious if any one of the name fields repeats a word (while ignoring initials) from the other name field.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">    Parameters:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">        flag_name (str) : Flag name. </span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">        column_first_name (str) : Column name for the first name.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">        column_last_name (str) : Column name for the last name.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">        min_word_length (int) : Minimum length of a word to be considered for matching.</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">            Defaults to the recommended value of 2 to avoid initials. </span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">    Returns:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compare_names</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">min_word_length</span><span class="o">=</span><span class="n">min_word_length</span><span class="p">):</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">        Search for common (min_word_length) letter words in first and last name ignoring the lettercase.</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;(\w</span><span class="se">{{</span><span class="si">{</span><span class="n">min_word_length</span><span class="si">}</span><span class="s2">,</span><span class="se">}}</span><span class="s2">)&quot;</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="n">first_name_set</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="n">last_name_set</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="c1"># Strip and lowercase names for matching</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_first_name</span><span class="p">]):</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="n">first_name</span> <span class="o">=</span>  <span class="n">row</span><span class="p">[</span><span class="n">column_first_name</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="n">first_name_set</span> <span class="o">=</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">first_name</span><span class="p">))</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_last_name</span><span class="p">]):</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="n">last_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">column_last_name</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="n">last_name_set</span> <span class="o">=</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">last_name</span><span class="p">))</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="n">common_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">first_name_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">last_name_set</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span> 
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>    
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>    <span class="c1"># Check for all characters in all columns</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">compare_names</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_IPLocation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_ip</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="n">flag_missing</span><span class="p">,</span> <span class="n">region_level</span><span class="o">=</span><span class="s1">&#39;country&#39;</span><span class="p">):</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">    Adds a region location column `IPLocation` and a flag column to the dataframe based on the IP address.</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">    Parameters:</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        column_ip (str) : Column name for IP address. </span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">        target_region (str) : Region name that should not be flagged. See the notes below for details. Defaults to &#39;country&#39;.</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        flag_missing (bool) : Should missing data be flagged? True means missing data is flagged.</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        region_level (str) : The geographic level of the region to check. Can be either &#39;country&#39;, &#39;state&#39;, or &#39;city&#39;. </span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">            For example, &#39;country&#39; as &quot;US&quot;, &#39;state&#39; as &quot;California&quot;, and &#39;city&#39; as &quot;Mountain View&quot;.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">    Returns:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">geocoder</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>    <span class="k">if</span> <span class="n">region_level</span> <span class="o">==</span> <span class="s1">&#39;country&#39;</span><span class="p">:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_ip</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">geocoder</span><span class="o">.</span><span class="n">ip</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">country</span><span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>    <span class="k">elif</span> <span class="n">region_level</span> <span class="o">==</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_ip</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">geocoder</span><span class="o">.</span><span class="n">ip</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>    <span class="k">elif</span> <span class="n">region_level</span> <span class="o">==</span> <span class="s1">&#39;city&#39;</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_ip</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">geocoder</span><span class="o">.</span><span class="n">ip</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">city</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The region_level should be either </span><span class="se">\&#39;</span><span class="s2">country</span><span class="se">\&#39;</span><span class="s2">, </span><span class="se">\&#39;</span><span class="s2">state</span><span class="se">\&#39;</span><span class="s2">, or </span><span class="se">\&#39;</span><span class="s2">city</span><span class="se">\&#39;</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>    <span class="k">if</span> <span class="n">flag_missing</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_region</span><span class="p">),</span> 
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_region</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())),</span> 
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>        <span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_LatLongLocation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_latitude</span><span class="p">,</span> <span class="n">column_longitude</span><span class="p">,</span> <span class="n">target_country</span><span class="p">,</span> <span class="n">flag_missing</span><span class="p">):</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">    Adds a country column `LatLongLocation` and a flag column to the dataframe based on Latitude-Longtitude.</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">    Parameters:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        column_latitude (str) : Column name for Latitude.</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        column_longitude (str) : Column name for Longitude.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">        target_country (str) : Country name that should not be flagged. Verifies against the country&#39;s full name (e.g., &quot;United States of America&quot;).</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">        flag_missing (bool) : Should missing data be flagged? True means missing data is flagged.</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">    Returns:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">    &quot;&quot;&quot;</span>    
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span> <span class="c1"># LatLong</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span> <span class="c1"># LatLong</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">read_world_shape</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        Returns a Shapely dataframe with geometries of all countries</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">        Parameters:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">            fn (str) : Location of shape file.</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">        Returns:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">            df (pd.DataFrame) : Dataframe with country &#39;name&#39;, &#39;iso3&#39;, and &#39;geometry&#39;.</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="c1"># Reading the shapefile</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> 
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;iso3&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span> 
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>    
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="c1"># Search priority for countries that appear in the data often (these can be modified to improve performance)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># Creating additional column for counting country incidence</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s2">&quot;United States of America&quot;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s2">&quot;China&quot;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s2">&quot;India&quot;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;priority&#39;</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="k">return</span> <span class="n">df</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>    
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>    <span class="c1"># Read world shapefile data</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>    <span class="n">var_data</span> <span class="o">=</span> <span class="s2">&quot;world_shape_file&quot;</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>    <span class="k">if</span> <span class="n">var_data</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="sa">f</span><span class="s2">&quot;&#39;world_shape_file&#39; path not found in user_input in the parameters file. &quot;</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="sa">f</span><span class="s2">&quot;This shapefile is required to get country&#39;s name from latitude-longitude.&quot;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>    <span class="n">fn</span> <span class="o">=</span> <span class="n">filepaths</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filepaths</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">var_data</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>    <span class="n">df_world</span> <span class="o">=</span> <span class="n">read_world_shape</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="c1"># Need this for get_latlong_country()</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_latlong_country</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">long</span><span class="p">):</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="sd">        Returns the country and state of the given lat-long. Requires `df_world` dataframe.</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">        Parameters:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">            lat (float) : Latitude in degrees.</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">            long (float) : Longitude in degrees.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a><span class="sd">        Returns:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="sd">            country (str) : Country name. </span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">long</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">long</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="c1"># Note that it is long-lat in Point()</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="c1"># Use the spatial index to speed up the querying</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>        <span class="n">possible_matches_index</span> <span class="o">=</span> <span class="n">df_world</span><span class="o">.</span><span class="n">sindex</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">)</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="n">possible_matches</span> <span class="o">=</span> <span class="n">df_world</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">possible_matches_index</span><span class="p">]</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>        <span class="c1"># Searching for the point in country&#39;s geometry</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">possible_matches</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>            <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]):</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="c1"># Country</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>    
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;LatLongLocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_latlong_country</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">column_latitude</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">column_longitude</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>    <span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>    
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>    <span class="k">if</span> <span class="n">flag_missing</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;LatLongLocation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_country</span><span class="p">),</span> 
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>            <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;LatLongLocation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_country</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;LatLongLocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())),</span> 
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>            <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="c1">##### BETWEEN RESPONSE CHECKS #####</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_MultipleIPAttempts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_ip</span><span class="p">,</span> <span class="n">column_success</span><span class="p">,</span> <span class="n">num_attempts_lower</span><span class="p">,</span> 
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                            <span class="n">num_attempts_upper</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">attempt_type</span><span class="o">=</span><span class="s1">&#39;successful&#39;</span><span class="p">,</span> <span class="n">column_terminate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">    Adds a flag column to the dataframe for multiple attempts from the same IP network (i.e., the first three octets; e.g., 8.8.8).</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">    Also adds a `IPNetwork` columns to the dataframe. </span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">    The function can be defined to provide a lower bound and an upper bound to count the attempts. </span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">    It can also be modified to consider a specific type of attempt (e.g., successful or incomplete). </span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">    Parameters:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">        column_ip (str) : Column name with IP address.</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">        column_success (str) : Column name with a non-empty response treated as a successful attempt.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">        num_attempts_lower (int) : Minimum number of attempts from the same IP to be flagged (&gt;=).</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">        num_attempts_upper (int) : Maximum number of attempts from the same IP to be flagged (&lt;=).</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">            Defaults to np.inf.</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">        attempt_type (str) : Type of attempt to flag. Defaults to &#39;successful&#39;.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">            &#39;successful&#39; : attempts have a response for the `column_success` question.</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">            &#39;incomplete&#39; : attempts have no response for the `column_success` question and has no terminate flag.</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">            &#39;failed&#39; : attempts have no response for the `column_success` question and has a terminate flag.</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">            &#39;all&#39; : attempts irrespective of if it is successful or not.</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">        column_terminate (str) : Column name with terminate flag. Optional for &#39;successful&#39; attempt.</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">    Returns:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">    Notes:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">        Qualtrics can recode &quot;Seen but unanswered questions&quot; as -99. These are treated as &quot;successful&quot;.</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">        Qualtrics `Q_TerminateFlag` column marks unsuccessful responses as &quot;Screened&quot; or &quot;QuotaMet&quot;.</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>    
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">count_attempts</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">        Adds flags if number of attempts exceed the maximum attempt type</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">            </span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        Parameters:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">            group (pd.groupby): Group with the same IP network.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">            </span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        Returns:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">            group (pd.groupby): Group with the attempt type flag.</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="k">if</span> <span class="n">attempt_type</span> <span class="o">==</span> <span class="s1">&#39;successful&#39;</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">column_success</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="k">elif</span> <span class="n">attempt_type</span> <span class="o">==</span> <span class="s1">&#39;incomplete&#39;</span><span class="p">:</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>            <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">column_success</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">group</span><span class="p">[</span><span class="n">column_terminate</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        <span class="k">elif</span> <span class="n">attempt_type</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>            <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">column_success</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">group</span><span class="p">[</span><span class="n">column_terminate</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="k">elif</span> <span class="n">attempt_type</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>            <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid attempt_type: </span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>            
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="n">group</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>            <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">num_attempts_lower</span><span class="p">)</span> 
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>            <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">num_attempts_upper</span><span class="p">)),</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>            <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>        <span class="k">return</span> <span class="n">group</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>    
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>    <span class="c1"># Add a column for the network portion of the IP address (ignoring the host/device portion)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPNetwork&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_ip</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ip</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;IPNetwork&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">count_attempts</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>    
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_BurstResponses</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_start_time</span><span class="p">,</span> <span class="n">column_duration</span><span class="p">,</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                        <span class="n">max_start_time_difference</span><span class="p">,</span> <span class="n">max_duration_difference</span><span class="p">,</span> 
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                        <span class="n">unflag_start_time_difference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unflag_duration_difference</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">    Adds a flag column to the dataframe for burst of responses with similar start times and durations.</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">    Adds an additional column with number of burst responses `NumBurstResponses`.</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="sd">    This method implements a lower bound and an upper bound for start time and duration differences to allow for graded flagging. </span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a><span class="sd">    Parameters:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="sd">        column_start_time (str) : Column name for survey start date and time.</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="sd">        column_duration (str) : Column name for survey duration.</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="sd">        max_start_time_difference (int) : Maximum absolute difference between start times.</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">        max_duration_difference (int) : Maximum absolute difference between survey durations.</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">        unflag_start_time_difference (int) : Maximum start time difference for not flagging the responses.</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">        unflag_duration_difference (int) : Maximum duration difference for not flagging the responses.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">        </span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">    Returns:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>    <span class="c1"># Copying dataframe and converting start time column to datetime </span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>    <span class="n">nearby_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">column_start_time</span><span class="p">,</span> <span class="n">column_duration</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>    <span class="n">nearby_df</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">nearby_df</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">])</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>    
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_num_responses</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">max_start</span><span class="p">,</span> <span class="n">max_duration</span><span class="p">):</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">        Returns indices of all rows that are within the maximum start time and duration threshold for the input row.</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">            </span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">        Parameters:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="sd">            row (pd.Series): A single row of the dataframe. </span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a><span class="sd">            max_start_time (int) : Maximum absolute difference between start times.</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="sd">            max_duration (int) : Maximum absolute difference between survey durations.</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="sd">            </span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="sd">        Returns:</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">            num_responses (int) : Number of nearby responses near the input row.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="c1"># Start time and duration must exist (may have missing data if multiple surveys are merged)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_duration</span><span class="p">]):</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="n">diff_start_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">nearby_df</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="n">diff_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nearby_df</span><span class="p">[</span><span class="n">column_duration</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="n">column_duration</span><span class="p">])</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">diff_start_time</span> <span class="o">&lt;=</span> <span class="n">max_start</span><span class="p">)</span> 
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="o">&amp;</span> <span class="p">(</span><span class="n">diff_duration</span> <span class="o">&lt;=</span> <span class="n">max_duration</span><span class="p">))</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="n">idxs</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="c1"># Get indexes of nearby responses</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="c1"># idxs can be empty if min_start_time_difference != 0</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="n">idxs</span> <span class="o">=</span> <span class="n">idxs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="c1"># Remove self index</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="n">num_responses</span> <span class="o">=</span> <span class="n">idxs</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>        <span class="k">return</span> <span class="n">num_responses</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>    
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>    <span class="c1"># Unflagging when using multiple burst flags (to avoid double counting)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>    <span class="n">nearby_df</span><span class="p">[</span><span class="s1">&#39;unflag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>    <span class="k">if</span> <span class="n">unflag_start_time_difference</span> <span class="ow">and</span> <span class="n">unflag_duration_difference</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="n">nearby_df</span><span class="p">[</span><span class="s1">&#39;unflag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nearby_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_num_responses</span><span class="p">,</span> 
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                                       <span class="n">max_start</span><span class="o">=</span><span class="n">unflag_start_time_difference</span><span class="p">,</span> 
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>                                       <span class="n">max_duration</span><span class="o">=</span><span class="n">unflag_duration_difference</span><span class="p">,</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                                       <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>    
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>    <span class="c1"># Add a column with number of similar responses</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>    <span class="n">num_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;F</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">_count&quot;</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">num_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nearby_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_num_responses</span><span class="p">,</span> 
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>                                  <span class="n">max_start</span><span class="o">=</span><span class="n">max_start_time_difference</span><span class="p">,</span> 
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                                  <span class="n">max_duration</span><span class="o">=</span><span class="n">max_duration_difference</span><span class="p">,</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                                  <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                  <span class="o">-</span> <span class="n">nearby_df</span><span class="p">[</span><span class="s1">&#39;unflag&#39;</span><span class="p">])</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>    
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">num_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a><span class="nd">@summary_wrapper</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_DuplicatedText</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">list_of_columns</span><span class="p">,</span> <span class="n">min_length</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> 
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>                                 <span class="n">search_strategy</span><span class="o">=</span><span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="n">create_column_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">    Adds a flag column to the dataframe for very short survey duration.</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">        </span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">    Parameters:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">        list_of_columns (List[str]) : List of column names for text responses.</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">        min_length (int) : Minimum string length of text responses.</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">        max_length (int) : Maximum string length of text responses.</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">        search_strategy (str) : Search strategy to mark duplicates. Defaults to &#39;column&#39;.</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">            &#39;column&#39; looks for duplicates within each text column and flags if any of the columns contains a duplicate. </span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="sd">                This strategy creates flags for individual columns as well.</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a><span class="sd">            &#39;all&#39; looks for duplicates across all text columns.</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="sd">        create_column_flag (boolean): Bollean to add column-wise flag. Defaults to False.</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="sd">        </span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="sd">    Returns:</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>    <span class="c1"># Create individual flag for columns with duplicates</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>    
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>    <span class="c1"># Convert string object (if any) to list</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_of_columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        <span class="n">list_of_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_of_columns</span><span class="p">]</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>    
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>    <span class="c1">## Search strategies</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="k">if</span> <span class="n">search_strategy</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span><span class="p">:</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">list_of_columns</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>            <span class="c1"># Strips and lowercase all text responses</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>            <span class="n">lower_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>                <span class="p">(</span><span class="n">lower_df</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_length</span><span class="p">)</span> 
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>                <span class="o">&amp;</span> <span class="p">(</span><span class="n">lower_df</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>                <span class="o">&amp;</span> <span class="p">(</span><span class="n">lower_df</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>                <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">lower_df</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="c1"># Create a flag for each individual column</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="k">if</span> <span class="n">create_column_flag</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>                <span class="n">flag_name_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>                <span class="n">df</span><span class="p">[</span><span class="n">flag_name_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> 
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>    
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            <span class="c1"># Combined flag across all columns. Marks if any column value is duplicated</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>            <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mask</span> <span class="c1"># Use |= for any column flagged and &amp;= for all column flagged</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>        
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>    <span class="k">elif</span> <span class="n">search_strategy</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="c1"># Flatten the dataFrame while preserving the original index</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>        <span class="n">flattened_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">list_of_columns</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="c1"># &#39;level_0&#39; is the original index, and 0 are the values</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>        <span class="n">flattened_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;original_index&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>        <span class="c1"># Strips and lowercase all text responses</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>        
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>        <span class="c1"># Check for duplicates (count number of occurences within the entire dataframe)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="n">duplicates_all</span> <span class="o">=</span> <span class="n">flattened_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;value&#39;</span><span class="p">])[</span><span class="s1">&#39;original_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">((</span><span class="n">duplicates_all</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># number of occurences &gt; 1</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>                      <span class="o">&amp;</span> <span class="p">(</span><span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_length</span><span class="p">)</span>  <span class="c1"># string length check</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>                      <span class="o">&amp;</span> <span class="p">(</span><span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">))</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>        <span class="c1"># Map these duplicate flag_names back to the original DataFrame&#39;s index</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;original_index&#39;</span><span class="p">][</span><span class="n">duplicates</span><span class="p">])</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The search strategy should be either &#39;column&#39; or &#39;all&#39;. Instead, the strategy provided is </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">search_strategy</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>        
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="c1">###################################</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a><span class="c1">##### RESPONSE CLASSIFICATION #####</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="c1">###################################</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a><span class="k">def</span><span class="w"> </span><span class="nf">decode_special_floats</span><span class="p">(</span><span class="n">dct</span><span class="p">):</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="sd">    Converts the special values (e.g., infinity) in the JSON object in the parameters file to Python numeric values. </span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="sd">    The parameters file accepts the following values:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a><span class="sd">        Positive infinity as &quot;infinity&quot; or &quot;inf&quot;.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">        Negative infinity as &quot;-infinity&quot; or &quot;-inf&quot;.</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">        Empty or missing values as &quot;nan&quot;, &quot;nil&quot;, or &quot;none&quot;.</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">        True as &quot;true&quot;.</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a><span class="sd">        False as &quot;false&quot;.</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">    Parameters:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a><span class="sd">        dct (dict) : Dictionary with JSON values.</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a><span class="sd">        </span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="sd">    Returns:</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="sd">        dct (dict) : Dictionary with corresponding Python values.</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;infinity&quot;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;inf&quot;</span><span class="p">:</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;-infinity&quot;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;-inf&quot;</span><span class="p">:</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;nil&quot;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>    <span class="k">return</span> <span class="n">dct</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a><span class="k">def</span><span class="w"> </span><span class="nf">flag_responses</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params_sheet</span><span class="p">,</span> <span class="n">add_string</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a><span class="sd">    Applies the flags provided by the user. </span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a><span class="sd">    Parameters:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with survey data. </span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a><span class="sd">        params_sheet (str) : Excel sheet name in the parameters file with flag information (&#39;flags&#39;)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a><span class="sd">            Must contain columns &#39;flag_name&#39;, &#39;method_name&#39;, &#39;flag_group&#39;, &#39;use_flag&#39;, &#39;parameters&#39;.</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a><span class="sd">        add_string (boolean) : Whether to add string-formatted columns for activated flags and flag groups. Defaults to True.</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a><span class="sd">    Returns:</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with added flag and flag group columns.</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>    <span class="c1">## Reading flag parameters</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">params_sheet</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>    <span class="c1"># Verify necessary columns</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">,</span> <span class="s1">&#39;method_name&#39;</span><span class="p">,</span> <span class="s1">&#39;flag_group&#39;</span><span class="p">,</span> <span class="s1">&#39;use_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns in sheet &#39;</span><span class="si">{</span><span class="n">params_sheet</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>    <span class="c1"># Drop inactive flags</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;use_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> 
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>    <span class="c1">## Apply individual flags</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">***** Executing: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> *****&quot;</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>        <span class="c1"># Read `parameters` columns in JSON format while decoding special floats</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>        <span class="n">flag_parameters</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">],</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">decode_special_floats</span><span class="p">)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>            <span class="nb">eval</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;method_name&#39;</span><span class="p">]),</span>       <span class="c1"># Method to implement `method_name`</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>            <span class="n">flag_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">],</span>     <span class="c1"># Flag name `flag_name`</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>            <span class="o">**</span><span class="n">flag_parameters</span>               <span class="c1"># Flag parameters `parameters`</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="p">)</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>      
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>    <span class="c1">## Add flag count by flag group</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>    <span class="n">dict_flags</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;flag_group&#39;</span><span class="p">)[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>    <span class="c1"># List of flags for each flag group</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>    <span class="k">for</span> <span class="n">flag_group</span><span class="p">,</span> <span class="n">list_flags</span> <span class="ow">in</span> <span class="n">dict_flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>        <span class="n">df</span><span class="p">[</span><span class="n">flag_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">list_flags</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                     <span class="c1"># Each flag in list_flags is a Boolean column </span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>    <span class="c1">## Add string-formatted columns for activated flags and flag groups</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>    <span class="k">if</span> <span class="n">add_string</span><span class="p">:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ActiveFlags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>            <span class="n">df</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>                             <span class="c1"># Selecting relevant columns </span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>                                                       <span class="c1"># Converts 0 to False</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># Join the column labels with True</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>        <span class="p">)</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ActiveFlagGroups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="n">df</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>                          <span class="c1"># Selecting relevant columns </span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>                                                       <span class="c1"># Converts 0 to False</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># Join the column labels with True</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a><span class="k">def</span><span class="w"> </span><span class="nf">classify_responses</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params_sheet</span><span class="p">):</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a><span class="sd">    Applies fraud classification rules loaded from an Excel file. Rules must be listed in the descending order of importance.</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a><span class="sd">    Parameters:</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag groups and relevant indicators.</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a><span class="sd">        params_sheet (str) : Excel sheet name in parametrs file with rule logic (&#39;initial_classification_rules&#39;).</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a><span class="sd">            Must contain columns &#39;rule_num&#39;, &#39;condition_expr&#39;, &#39;classification&#39;, &#39;use_rule&#39;.</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a><span class="sd">    Returns:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a><span class="sd">        classified_rules (pd.DataFrame) : Dataframe with flag `classification` and `rule_num` columns.</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>    <span class="c1">## Reading classification rule parameters</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">params_sheet</span><span class="p">)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>    <span class="c1"># Verify necessary columns</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rule_num&#39;</span><span class="p">,</span> <span class="s1">&#39;condition_expr&#39;</span><span class="p">,</span> <span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="s1">&#39;use_rule&#39;</span><span class="p">]</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns in sheet &#39;</span><span class="si">{</span><span class="n">params_sheet</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>    <span class="c1"># Drop inactive flags</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;use_rule&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> 
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_rules</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a><span class="sd">        Sequentially applies classification rules from the parameters to each response.</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a><span class="sd">        Stops exceuting further rules if a rules requirements are met. </span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a><span class="sd">        Raises an error if any rule cannot be evaluated.</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a><span class="sd">        Parameters:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a><span class="sd">            row (pd.Series) : A single row of the dataframe with required columns. </span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a><span class="sd">        Returns:</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="sd">            Tuple : A tuple with &#39;classification&#39; and &#39;rule_num&#39;.  </span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>        <span class="n">local_dict</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>                <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;condition_expr&#39;</span><span class="p">],</span> <span class="p">{},</span> <span class="n">local_dict</span><span class="p">):</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>                    <span class="k">return</span> <span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">],</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;rule_num&#39;</span><span class="p">])</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in </span><span class="si">{</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;rule_num&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> using the expression: </span><span class="si">{</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;condition_expr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>            
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;VALID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> 
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>    <span class="n">classified_rules</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">evaluate_rules</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span> <span class="c1"># Dataframe with two columns</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>    <span class="k">return</span> <span class="n">classified_rules</span>  
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a><span class="c1">#################################</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a><span class="c1">##### DESCRIPTIVE AND PLOTS #####</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="c1">#################################</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a><span class="k">def</span><span class="w"> </span><span class="nf">print_flag_counts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params_sheet</span><span class="p">):</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a><span class="sd">    Prints out simple counts of flags and flag groups. </span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a><span class="sd">    Parameters:</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with survey data. </span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a><span class="sd">        params_sheet (str) : Excel sheet name with flag information (&#39;flags&#39;).</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a><span class="sd">            Must contain columns &#39;flag_name&#39;, &#39;method_name&#39;, &#39;flag_group&#39;, &#39;use_flag&#39;, &#39;parameters&#39;.</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a><span class="sd">    Returns:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a><span class="sd">        None : This function prints response classification counts. </span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>    <span class="c1">## Reading flag parameters</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">params_sheet</span><span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>    <span class="c1"># Verify necessary columns</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">,</span> <span class="s1">&#39;method_name&#39;</span><span class="p">,</span> <span class="s1">&#39;flag_group&#39;</span><span class="p">,</span> <span class="s1">&#39;use_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns in sheet &#39;</span><span class="si">{</span><span class="n">params_sheet</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>    <span class="c1"># Drop inactive flags</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;use_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> 
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>    <span class="n">flags</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of unique responses flagged: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Total rows with at least one flag</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flags:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Table of flag counts</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>    <span class="n">flag_groups</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flag Groups:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">flag_groups</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Table of flag group counts</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a><span class="k">def</span><span class="w"> </span><span class="nf">print_classification_counts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_column</span><span class="p">):</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a><span class="sd">    Prints out simple counts of flags and flag groups. </span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a><span class="sd">    Parameters:</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with survey data. </span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a><span class="sd">        flag_column (str) : Column name for the flag classification. </span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a><span class="sd">            &#39;FLAG&#39; for algorithmic flags, &#39;MANUAL_FLAG&#39; for manual check flags, &#39;FINAL_FLAG&#39; for combined flags. </span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a><span class="sd">    Returns:</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a><span class="sd">        None : This function prints flag counts and flag group counts. </span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response classification: </span><span class="si">{</span><span class="n">flag_column</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">flag_column</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_flag_cooccurrence_heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_columns</span><span class="p">,</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>                                  <span class="n">params_sheet</span><span class="p">,</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>                                  <span class="n">use_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>                                  <span class="n">save_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>                                  <span class="n">display_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a><span class="sd">    Plots a square heatmap of co-occurrence between flags (or flag groups) and the response classification.</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a><span class="sd">    Parameters:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with survey data and flags.</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a><span class="sd">        flag_columns (List[str]) : Column names containing the classification (e.g., &#39;FLAG&#39;, &#39;MANUAL_FLAG&#39;, or &#39;FINAL_FLAG&#39;).</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a><span class="sd">        params_sheet (str) : Excel sheet name with flag information (&#39;flags&#39;).</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a><span class="sd">            Must contain columns &#39;flag_name&#39;, &#39;method_name&#39;, &#39;flag_group&#39;, &#39;use_flag&#39;, &#39;parameters&#39;.</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a><span class="sd">        use_groups (bool) : If True, use flag groups instead of individual flags.</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a><span class="sd">        save_folder (str) : Optional folder path to save the heatmap.</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a><span class="sd">        display_figure (bool) : If True, display created figures. Defaults to True.</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a><span class="sd">    Returns:</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a><span class="sd">        None : Displays a seaborn heatmap.</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ticker</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>    <span class="c1">## Reading classification rule parameters</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">params_sheet</span><span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>    <span class="c1"># Verify necessary columns</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">,</span> <span class="s1">&#39;method_name&#39;</span><span class="p">,</span> <span class="s1">&#39;flag_group&#39;</span><span class="p">,</span> <span class="s1">&#39;use_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns in sheet &#39;</span><span class="si">{</span><span class="n">params_sheet</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>    <span class="c1"># Drop inactive flags</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;use_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> 
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>    <span class="c1"># Identify relevant flag columns</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>    <span class="n">column_key</span> <span class="o">=</span> <span class="s1">&#39;flag_group&#39;</span> <span class="k">if</span> <span class="n">use_groups</span> <span class="k">else</span> <span class="s1">&#39;flag_name&#39;</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="n">column_key</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>    
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>    <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">flag_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>    <span class="k">if</span> <span class="n">missing_cols</span><span class="p">:</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing column(s) in DataFrame: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>    <span class="c1"># Binary matrix for classifications</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>    <span class="n">classification_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">flag_columns</span><span class="p">])</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>    <span class="n">classification_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>        <span class="n">classification_dummies</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>    <span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>    <span class="n">flag_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>        <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>    <span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>    <span class="c1"># Combine and compute co-occurrence matrix</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>    <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">flag_df</span><span class="p">,</span> <span class="n">classification_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>    <span class="n">co_matrix</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">combined</span>  <span class="c1"># True count of co-occurrences (dot product)</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>    <span class="c1"># Initialize heatmap</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_matrix</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_matrix</span><span class="p">)))</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>    <span class="n">heatmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">co_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">,</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>                          <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">fontsize</span><span class="p">},</span> <span class="n">cbar_ax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>                          <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Co-occurrence of </span><span class="si">{</span><span class="s1">&#39;Flag Groups&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">use_groups</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Flags&#39;</span><span class="si">}</span><span class="s2"> and classified responses (</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flag_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span> <span class="c1"># Square heatmap</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>    <span class="c1"># Force colorbar ticks to be integers</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>    <span class="n">cbar</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>    <span class="c1"># Prepare group boundaries for visual separation</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>    <span class="k">if</span> <span class="n">use_groups</span><span class="p">:</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>        <span class="n">df_flags</span> <span class="o">=</span> <span class="n">params</span><span class="p">[[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>        <span class="n">df_flags</span> <span class="o">=</span> <span class="n">params</span><span class="p">[[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">,</span> <span class="s1">&#39;flag_group&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;EMPTY&#39;</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>        <span class="n">df_flags</span> <span class="o">=</span> <span class="n">df_flags</span><span class="p">[</span><span class="n">df_flags</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">columns</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>    <span class="n">group_boundaries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_flags</span><span class="p">[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>        <span class="n">max_index</span> <span class="o">=</span> <span class="n">df_flags</span><span class="p">[</span><span class="n">df_flags</span><span class="p">[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>        <span class="n">group_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_index</span><span class="p">)</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>    <span class="n">group_boundaries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">group_boundaries</span><span class="p">))</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>    <span class="c1"># Draw visual borders</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>    <span class="n">flag_end_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a>    <span class="n">total_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_matrix</span><span class="p">)</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>    <span class="c1"># Starting border (left and top)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_groups</span><span class="p">:</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a>        <span class="k">for</span> <span class="n">boundary</span> <span class="ow">in</span> <span class="n">group_boundaries</span><span class="p">:</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">boundary</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">boundary</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a>    <span class="c1"># Classfication border</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">flag_end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">flag_end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a>    <span class="c1"># Ending border (right and bottom)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">total_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">total_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a>    <span class="c1"># Save and Display</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a>    <span class="k">if</span> <span class="n">save_folder</span><span class="p">:</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_folder</span><span class="p">):</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The folder path </span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a>        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;FG&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">use_groups</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;F&#39;</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flag_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a>    <span class="k">if</span> <span class="n">display_figure</span><span class="p">:</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>    <span class="k">pass</span>
</span></pre></div>


            </section>
                <section id="FN_PARAMETERS">
                    <div class="attr variable">
            <span class="name">FN_PARAMETERS</span>        =
<span class="default_value">&#39;./config/parameters.xlsx&#39;</span>

        
    </div>
    <a class="headerlink" href="#FN_PARAMETERS"></a>
    
    

                </section>
                <section id="read_parameters_sheet">
                            <input id="read_parameters_sheet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">read_parameters_sheet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sheet_name</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="read_parameters_sheet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#read_parameters_sheet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="read_parameters_sheet-20"><a href="#read_parameters_sheet-20"><span class="linenos">20</span></a><span class="k">def</span><span class="w"> </span><span class="nf">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">):</span>
</span><span id="read_parameters_sheet-21"><a href="#read_parameters_sheet-21"><span class="linenos">21</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="read_parameters_sheet-22"><a href="#read_parameters_sheet-22"><span class="linenos">22</span></a><span class="sd">    Reads a specific worksheet from the parameters Excel file.</span>
</span><span id="read_parameters_sheet-23"><a href="#read_parameters_sheet-23"><span class="linenos">23</span></a>
</span><span id="read_parameters_sheet-24"><a href="#read_parameters_sheet-24"><span class="linenos">24</span></a><span class="sd">    Parameters:</span>
</span><span id="read_parameters_sheet-25"><a href="#read_parameters_sheet-25"><span class="linenos">25</span></a><span class="sd">        sheet_name (str): The name of the worksheet to read.</span>
</span><span id="read_parameters_sheet-26"><a href="#read_parameters_sheet-26"><span class="linenos">26</span></a>
</span><span id="read_parameters_sheet-27"><a href="#read_parameters_sheet-27"><span class="linenos">27</span></a><span class="sd">    Returns:</span>
</span><span id="read_parameters_sheet-28"><a href="#read_parameters_sheet-28"><span class="linenos">28</span></a><span class="sd">        params (pd.DataFrame): DataFrame containing the sheet&#39;s contents.</span>
</span><span id="read_parameters_sheet-29"><a href="#read_parameters_sheet-29"><span class="linenos">29</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="read_parameters_sheet-30"><a href="#read_parameters_sheet-30"><span class="linenos">30</span></a>    <span class="n">excel_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelFile</span><span class="p">(</span><span class="n">FN_PARAMETERS</span><span class="p">)</span>
</span><span id="read_parameters_sheet-31"><a href="#read_parameters_sheet-31"><span class="linenos">31</span></a>    <span class="k">if</span> <span class="n">sheet_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excel_file</span><span class="o">.</span><span class="n">sheet_names</span><span class="p">:</span>
</span><span id="read_parameters_sheet-32"><a href="#read_parameters_sheet-32"><span class="linenos">32</span></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
</span><span id="read_parameters_sheet-33"><a href="#read_parameters_sheet-33"><span class="linenos">33</span></a>            <span class="sa">f</span><span class="s2">&quot;Worksheet &#39;</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&#39; not found in &#39;</span><span class="si">{</span><span class="n">FN_PARAMETERS</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
</span><span id="read_parameters_sheet-34"><a href="#read_parameters_sheet-34"><span class="linenos">34</span></a>            <span class="sa">f</span><span class="s2">&quot;Available sheets: </span><span class="si">{</span><span class="n">excel_file</span><span class="o">.</span><span class="n">sheet_names</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="read_parameters_sheet-35"><a href="#read_parameters_sheet-35"><span class="linenos">35</span></a>        <span class="p">)</span>
</span><span id="read_parameters_sheet-36"><a href="#read_parameters_sheet-36"><span class="linenos">36</span></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">excel_file</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reads a specific worksheet from the parameters Excel file.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sheet_name (str):</strong>  The name of the worksheet to read.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>params (pd.DataFrame): DataFrame containing the sheet's contents.</p>
</blockquote>
</div>


                </section>
                <section id="filepaths">
                    <div class="attr variable">
            <span class="name">filepaths</span>        =
<input id="filepaths-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="filepaths-view-value"></label><span class="default_value">           parameter                                              value                                        description
0          data_file                             ./data/sample_data.csv  File path of the base survey data file with co...
1       flagged_file                            ./data/flagged_data.csv  File path of the output file with algorithmic ...
2   world_shape_file  ./config/world-administrative-boundaries/world...  File path of the shape (.shp) file. Required t...
3      figure_folder                                         ./figures/                       Folder path to save figures.
4        manual_file                            ./data/flagged_data.csv  File path of the file with both algorithmic fl...
5  final_output_file                                  ./data/output.csv  File path of the file with the final flag comb...</span>

        
    </div>
    <a class="headerlink" href="#filepaths"></a>
    
    

                </section>
                <section id="summary_wrapper">
                            <input id="summary_wrapper-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">summary_wrapper</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">func</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="summary_wrapper-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#summary_wrapper"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="summary_wrapper-45"><a href="#summary_wrapper-45"><span class="linenos">45</span></a><span class="k">def</span><span class="w"> </span><span class="nf">summary_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="summary_wrapper-46"><a href="#summary_wrapper-46"><span class="linenos">46</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="summary_wrapper-47"><a href="#summary_wrapper-47"><span class="linenos">47</span></a><span class="sd">    Wrapper function to run a method, log execution time and flag summary,</span>
</span><span id="summary_wrapper-48"><a href="#summary_wrapper-48"><span class="linenos">48</span></a><span class="sd">    and handle exceptions gracefully without interrupting the pipeline.</span>
</span><span id="summary_wrapper-49"><a href="#summary_wrapper-49"><span class="linenos">49</span></a>
</span><span id="summary_wrapper-50"><a href="#summary_wrapper-50"><span class="linenos">50</span></a><span class="sd">    Parameters:</span>
</span><span id="summary_wrapper-51"><a href="#summary_wrapper-51"><span class="linenos">51</span></a><span class="sd">        func (function): The function to be wrapped.</span>
</span><span id="summary_wrapper-52"><a href="#summary_wrapper-52"><span class="linenos">52</span></a>
</span><span id="summary_wrapper-53"><a href="#summary_wrapper-53"><span class="linenos">53</span></a><span class="sd">    Returns:</span>
</span><span id="summary_wrapper-54"><a href="#summary_wrapper-54"><span class="linenos">54</span></a><span class="sd">        function: A wrapped version of the input function.</span>
</span><span id="summary_wrapper-55"><a href="#summary_wrapper-55"><span class="linenos">55</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="summary_wrapper-56"><a href="#summary_wrapper-56"><span class="linenos">56</span></a>    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>  <span class="c1"># Preserve the name and docstring of the function</span>
</span><span id="summary_wrapper-57"><a href="#summary_wrapper-57"><span class="linenos">57</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="summary_wrapper-58"><a href="#summary_wrapper-58"><span class="linenos">58</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="summary_wrapper-59"><a href="#summary_wrapper-59"><span class="linenos">59</span></a>        <span class="n">flag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag&#39;</span><span class="p">)</span>
</span><span id="summary_wrapper-60"><a href="#summary_wrapper-60"><span class="linenos">60</span></a>        <span class="n">method_name</span> <span class="o">=</span> <span class="n">flag</span> <span class="k">if</span> <span class="n">flag</span> <span class="k">else</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="summary_wrapper-61"><a href="#summary_wrapper-61"><span class="linenos">61</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="summary_wrapper-62"><a href="#summary_wrapper-62"><span class="linenos">62</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="summary_wrapper-63"><a href="#summary_wrapper-63"><span class="linenos">63</span></a>            <span class="c1"># Error handling for method</span>
</span><span id="summary_wrapper-64"><a href="#summary_wrapper-64"><span class="linenos">64</span></a>            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="summary_wrapper-65"><a href="#summary_wrapper-65"><span class="linenos">65</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="summary_wrapper-66"><a href="#summary_wrapper-66"><span class="linenos">66</span></a>                    <span class="sa">f</span><span class="s2">&quot;The dataframe does not exist after executing &#39;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
</span><span id="summary_wrapper-67"><a href="#summary_wrapper-67"><span class="linenos">67</span></a>                    <span class="sa">f</span><span class="s2">&quot;Make sure the corresponding parameters are correct.&quot;</span>
</span><span id="summary_wrapper-68"><a href="#summary_wrapper-68"><span class="linenos">68</span></a>                <span class="p">)</span>
</span><span id="summary_wrapper-69"><a href="#summary_wrapper-69"><span class="linenos">69</span></a>            <span class="c1"># Flag summary</span>
</span><span id="summary_wrapper-70"><a href="#summary_wrapper-70"><span class="linenos">70</span></a>            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span id="summary_wrapper-71"><a href="#summary_wrapper-71"><span class="linenos">71</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of flagged responses for </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="summary_wrapper-72"><a href="#summary_wrapper-72"><span class="linenos">72</span></a>
</span><span id="summary_wrapper-73"><a href="#summary_wrapper-73"><span class="linenos">73</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="summary_wrapper-74"><a href="#summary_wrapper-74"><span class="linenos">74</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&#39; took </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">)</span>
</span><span id="summary_wrapper-75"><a href="#summary_wrapper-75"><span class="linenos">75</span></a>            <span class="k">return</span> <span class="n">result</span>
</span><span id="summary_wrapper-76"><a href="#summary_wrapper-76"><span class="linenos">76</span></a>        
</span><span id="summary_wrapper-77"><a href="#summary_wrapper-77"><span class="linenos">77</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="summary_wrapper-78"><a href="#summary_wrapper-78"><span class="linenos">78</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR exeucting &#39;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="summary_wrapper-79"><a href="#summary_wrapper-79"><span class="linenos">79</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="summary_wrapper-80"><a href="#summary_wrapper-80"><span class="linenos">80</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="summary_wrapper-81"><a href="#summary_wrapper-81"><span class="linenos">81</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&#39; took </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">)</span>
</span><span id="summary_wrapper-82"><a href="#summary_wrapper-82"><span class="linenos">82</span></a>
</span><span id="summary_wrapper-83"><a href="#summary_wrapper-83"><span class="linenos">83</span></a>    <span class="k">return</span> <span class="n">wrapper</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper function to run a method, log execution time and flag summary,
and handle exceptions gracefully without interrupting the pipeline.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>func (function):</strong>  The function to be wrapped.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>function: A wrapped version of the input function.</p>
</blockquote>
</div>


                </section>
                <section id="check_ValueInRange">
                            <input id="check_ValueInRange-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_ValueInRange</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">flag_name</span>, </span><span class="param"><span class="n">column_name</span>, </span><span class="param"><span class="n">lower_threshold</span>, </span><span class="param"><span class="n">upper_threshold</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_ValueInRange-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_ValueInRange"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_ValueInRange-87"><a href="#check_ValueInRange-87"><span class="linenos"> 87</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_ValueInRange-88"><a href="#check_ValueInRange-88"><span class="linenos"> 88</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_ValueInRange</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">lower_threshold</span><span class="p">,</span> <span class="n">upper_threshold</span><span class="p">):</span>
</span><span id="check_ValueInRange-89"><a href="#check_ValueInRange-89"><span class="linenos"> 89</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_ValueInRange-90"><a href="#check_ValueInRange-90"><span class="linenos"> 90</span></a><span class="sd">    Adds a flag column to the dataframe if the column value is within the threshold.</span>
</span><span id="check_ValueInRange-91"><a href="#check_ValueInRange-91"><span class="linenos"> 91</span></a>
</span><span id="check_ValueInRange-92"><a href="#check_ValueInRange-92"><span class="linenos"> 92</span></a><span class="sd">    Parameters:</span>
</span><span id="check_ValueInRange-93"><a href="#check_ValueInRange-93"><span class="linenos"> 93</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant data.</span>
</span><span id="check_ValueInRange-94"><a href="#check_ValueInRange-94"><span class="linenos"> 94</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="check_ValueInRange-95"><a href="#check_ValueInRange-95"><span class="linenos"> 95</span></a><span class="sd">        column_name (str) : Column name to check for threshold.</span>
</span><span id="check_ValueInRange-96"><a href="#check_ValueInRange-96"><span class="linenos"> 96</span></a><span class="sd">        lower_threshold (float) : Values &gt;= lower threshold value are flagged.</span>
</span><span id="check_ValueInRange-97"><a href="#check_ValueInRange-97"><span class="linenos"> 97</span></a><span class="sd">        upper_threshold (float) : Values &lt;= upper threshold value are flagged.</span>
</span><span id="check_ValueInRange-98"><a href="#check_ValueInRange-98"><span class="linenos"> 98</span></a>
</span><span id="check_ValueInRange-99"><a href="#check_ValueInRange-99"><span class="linenos"> 99</span></a><span class="sd">    Returns:</span>
</span><span id="check_ValueInRange-100"><a href="#check_ValueInRange-100"><span class="linenos">100</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with the flag.</span>
</span><span id="check_ValueInRange-101"><a href="#check_ValueInRange-101"><span class="linenos">101</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_ValueInRange-102"><a href="#check_ValueInRange-102"><span class="linenos">102</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lower_threshold</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper_threshold</span><span class="p">)</span>
</span><span id="check_ValueInRange-103"><a href="#check_ValueInRange-103"><span class="linenos">103</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="check_ValueInRange-104"><a href="#check_ValueInRange-104"><span class="linenos">104</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a flag column to the dataframe if the column value is within the threshold.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with relevant data.</li>
<li><strong>flag_name (str) :</strong>  Flag name.</li>
<li><strong>column_name (str) :</strong>  Column name to check for threshold.</li>
<li><strong>lower_threshold (float) :</strong>  Values &gt;= lower threshold value are flagged.</li>
<li><strong>upper_threshold (float) :</strong>  Values &lt;= upper threshold value are flagged.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with the flag.</p>
</blockquote>
</div>


                </section>
                <section id="check_CustomCondition">
                            <input id="check_CustomCondition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_CustomCondition</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">flag_name</span>, </span><span class="param"><span class="n">condition</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_CustomCondition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_CustomCondition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_CustomCondition-106"><a href="#check_CustomCondition-106"><span class="linenos">106</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_CustomCondition-107"><a href="#check_CustomCondition-107"><span class="linenos">107</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_CustomCondition</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
</span><span id="check_CustomCondition-108"><a href="#check_CustomCondition-108"><span class="linenos">108</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_CustomCondition-109"><a href="#check_CustomCondition-109"><span class="linenos">109</span></a><span class="sd">    Adds a flag column to the dataframe based on the given boolean condition.</span>
</span><span id="check_CustomCondition-110"><a href="#check_CustomCondition-110"><span class="linenos">110</span></a>
</span><span id="check_CustomCondition-111"><a href="#check_CustomCondition-111"><span class="linenos">111</span></a><span class="sd">    Parameters:</span>
</span><span id="check_CustomCondition-112"><a href="#check_CustomCondition-112"><span class="linenos">112</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="check_CustomCondition-113"><a href="#check_CustomCondition-113"><span class="linenos">113</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="check_CustomCondition-114"><a href="#check_CustomCondition-114"><span class="linenos">114</span></a><span class="sd">        condition (str) : A Boolean condition written in Pandas evaluate expression format. </span>
</span><span id="check_CustomCondition-115"><a href="#check_CustomCondition-115"><span class="linenos">115</span></a><span class="sd">            See https://pandas.pydata.org/docs/reference/api/pandas.eval.html for details.</span>
</span><span id="check_CustomCondition-116"><a href="#check_CustomCondition-116"><span class="linenos">116</span></a>
</span><span id="check_CustomCondition-117"><a href="#check_CustomCondition-117"><span class="linenos">117</span></a><span class="sd">    Returns:</span>
</span><span id="check_CustomCondition-118"><a href="#check_CustomCondition-118"><span class="linenos">118</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="check_CustomCondition-119"><a href="#check_CustomCondition-119"><span class="linenos">119</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_CustomCondition-120"><a href="#check_CustomCondition-120"><span class="linenos">120</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
</span><span id="check_CustomCondition-121"><a href="#check_CustomCondition-121"><span class="linenos">121</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a flag column to the dataframe based on the given boolean condition.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with relevant columns.</li>
<li><strong>flag_name (str) :</strong>  Flag name.</li>
<li><strong>condition (str) :</strong>  A Boolean condition written in Pandas evaluate expression format. 
See <a href="https://pandas.pydata.org/docs/reference/api/pandas.eval.html">https://pandas.pydata.org/docs/reference/api/pandas.eval.html</a> for details.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with flag.</p>
</blockquote>
</div>


                </section>
                <section id="check_ReverseCodedResponse">
                            <input id="check_ReverseCodedResponse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_ReverseCodedResponse</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">flag_name</span>,</span><span class="param">	<span class="n">positive_columns</span>,</span><span class="param">	<span class="n">negative_columns</span>,</span><span class="param">	<span class="n">min_score</span>,</span><span class="param">	<span class="n">max_score</span>,</span><span class="param">	<span class="n">max_correlation</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_ReverseCodedResponse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_ReverseCodedResponse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_ReverseCodedResponse-123"><a href="#check_ReverseCodedResponse-123"><span class="linenos">123</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_ReverseCodedResponse-124"><a href="#check_ReverseCodedResponse-124"><span class="linenos">124</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_ReverseCodedResponse</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">positive_columns</span><span class="p">,</span> <span class="n">negative_columns</span><span class="p">,</span> 
</span><span id="check_ReverseCodedResponse-125"><a href="#check_ReverseCodedResponse-125"><span class="linenos">125</span></a>                              <span class="n">min_score</span><span class="p">,</span> <span class="n">max_score</span><span class="p">,</span> <span class="n">max_correlation</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="check_ReverseCodedResponse-126"><a href="#check_ReverseCodedResponse-126"><span class="linenos">126</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_ReverseCodedResponse-127"><a href="#check_ReverseCodedResponse-127"><span class="linenos">127</span></a><span class="sd">    Adds a flag column to the dataframe if the mean score of reverse-coded items is negatively correlated to the mean score of their counterparts.</span>
</span><span id="check_ReverseCodedResponse-128"><a href="#check_ReverseCodedResponse-128"><span class="linenos">128</span></a><span class="sd">    The method normalizes the items based on min_score and max_score, and removes recoding artifacts (e.g., -99 for unanswered items). </span>
</span><span id="check_ReverseCodedResponse-129"><a href="#check_ReverseCodedResponse-129"><span class="linenos">129</span></a><span class="sd">    This method can be applied to constructs that should be negatively correlated as well. </span>
</span><span id="check_ReverseCodedResponse-130"><a href="#check_ReverseCodedResponse-130"><span class="linenos">130</span></a>
</span><span id="check_ReverseCodedResponse-131"><a href="#check_ReverseCodedResponse-131"><span class="linenos">131</span></a><span class="sd">    Parameters:</span>
</span><span id="check_ReverseCodedResponse-132"><a href="#check_ReverseCodedResponse-132"><span class="linenos">132</span></a><span class="sd">        df (pd.DataFrame) : DataFrame with relevant columns.</span>
</span><span id="check_ReverseCodedResponse-133"><a href="#check_ReverseCodedResponse-133"><span class="linenos">133</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="check_ReverseCodedResponse-134"><a href="#check_ReverseCodedResponse-134"><span class="linenos">134</span></a><span class="sd">        positive_columns (List[str]) : List of column names representing positive responses.</span>
</span><span id="check_ReverseCodedResponse-135"><a href="#check_ReverseCodedResponse-135"><span class="linenos">135</span></a><span class="sd">        negative_columns (List[str]) : List of column names representing negative responses.</span>
</span><span id="check_ReverseCodedResponse-136"><a href="#check_ReverseCodedResponse-136"><span class="linenos">136</span></a><span class="sd">        min_score (int) : Minimum possible score for the columns.</span>
</span><span id="check_ReverseCodedResponse-137"><a href="#check_ReverseCodedResponse-137"><span class="linenos">137</span></a><span class="sd">        max_score (int) : Maximum possible score for the columns.</span>
</span><span id="check_ReverseCodedResponse-138"><a href="#check_ReverseCodedResponse-138"><span class="linenos">138</span></a><span class="sd">        max_correlation (float) : Correlation above which the data is flagged.</span>
</span><span id="check_ReverseCodedResponse-139"><a href="#check_ReverseCodedResponse-139"><span class="linenos">139</span></a>
</span><span id="check_ReverseCodedResponse-140"><a href="#check_ReverseCodedResponse-140"><span class="linenos">140</span></a><span class="sd">    Returns:</span>
</span><span id="check_ReverseCodedResponse-141"><a href="#check_ReverseCodedResponse-141"><span class="linenos">141</span></a><span class="sd">        df (pd.DataFrame) :Dataframe with the flag.</span>
</span><span id="check_ReverseCodedResponse-142"><a href="#check_ReverseCodedResponse-142"><span class="linenos">142</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_ReverseCodedResponse-143"><a href="#check_ReverseCodedResponse-143"><span class="linenos">143</span></a>    <span class="c1"># Keeping valid responses within range and normalize score between -1 and 1</span>
</span><span id="check_ReverseCodedResponse-144"><a href="#check_ReverseCodedResponse-144"><span class="linenos">144</span></a>    <span class="n">normalize_score</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">min_score</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_score</span> <span class="o">-</span> <span class="n">min_score</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="check_ReverseCodedResponse-145"><a href="#check_ReverseCodedResponse-145"><span class="linenos">145</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">positive_columns</span> <span class="o">+</span> <span class="n">negative_columns</span><span class="p">]</span>
</span><span id="check_ReverseCodedResponse-146"><a href="#check_ReverseCodedResponse-146"><span class="linenos">146</span></a>            <span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">normalize_score</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">min_score</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">max_score</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
</span><span id="check_ReverseCodedResponse-147"><a href="#check_ReverseCodedResponse-147"><span class="linenos">147</span></a>    
</span><span id="check_ReverseCodedResponse-148"><a href="#check_ReverseCodedResponse-148"><span class="linenos">148</span></a>    <span class="c1"># Find correlation between means</span>
</span><span id="check_ReverseCodedResponse-149"><a href="#check_ReverseCodedResponse-149"><span class="linenos">149</span></a>    <span class="n">mean_positives</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">positive_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="check_ReverseCodedResponse-150"><a href="#check_ReverseCodedResponse-150"><span class="linenos">150</span></a>    <span class="n">mean_negatives</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">negative_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="check_ReverseCodedResponse-151"><a href="#check_ReverseCodedResponse-151"><span class="linenos">151</span></a>    <span class="n">correlation</span> <span class="o">=</span> <span class="n">mean_positives</span> <span class="o">*</span> <span class="n">mean_negatives</span>
</span><span id="check_ReverseCodedResponse-152"><a href="#check_ReverseCodedResponse-152"><span class="linenos">152</span></a>    <span class="c1"># Positive correlation is suspicious between reverse coded items</span>
</span><span id="check_ReverseCodedResponse-153"><a href="#check_ReverseCodedResponse-153"><span class="linenos">153</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">correlation</span> <span class="o">&gt;=</span> <span class="n">max_correlation</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="check_ReverseCodedResponse-154"><a href="#check_ReverseCodedResponse-154"><span class="linenos">154</span></a>
</span><span id="check_ReverseCodedResponse-155"><a href="#check_ReverseCodedResponse-155"><span class="linenos">155</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a flag column to the dataframe if the mean score of reverse-coded items is negatively correlated to the mean score of their counterparts.
The method normalizes the items based on min_score and max_score, and removes recoding artifacts (e.g., -99 for unanswered items). 
This method can be applied to constructs that should be negatively correlated as well. </p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  DataFrame with relevant columns.</li>
<li><strong>flag_name (str) :</strong>  Flag name.</li>
<li><strong>positive_columns (List[str]) :</strong>  List of column names representing positive responses.</li>
<li><strong>negative_columns (List[str]) :</strong>  List of column names representing negative responses.</li>
<li><strong>min_score (int) :</strong>  Minimum possible score for the columns.</li>
<li><strong>max_score (int) :</strong>  Maximum possible score for the columns.</li>
<li><strong>max_correlation (float) :</strong>  Correlation above which the data is flagged.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) :Dataframe with the flag.</p>
</blockquote>
</div>


                </section>
                <section id="check_SuspiciousCharacter">
                            <input id="check_SuspiciousCharacter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_SuspiciousCharacter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">flag_name</span>, </span><span class="param"><span class="n">list_of_columns</span>, </span><span class="param"><span class="n">list_of_chars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="se">\xa0</span><span class="s1">&#39;</span><span class="p">]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_SuspiciousCharacter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_SuspiciousCharacter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_SuspiciousCharacter-157"><a href="#check_SuspiciousCharacter-157"><span class="linenos">157</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_SuspiciousCharacter-158"><a href="#check_SuspiciousCharacter-158"><span class="linenos">158</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_SuspiciousCharacter</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">list_of_columns</span><span class="p">,</span> <span class="n">list_of_chars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;</span><span class="se">\xa0</span><span class="s2">&quot;</span><span class="p">]):</span>
</span><span id="check_SuspiciousCharacter-159"><a href="#check_SuspiciousCharacter-159"><span class="linenos">159</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_SuspiciousCharacter-160"><a href="#check_SuspiciousCharacter-160"><span class="linenos">160</span></a><span class="sd">    Adds a flag column to the dataframe if there are suspicious characters (e.g., non-breaking character) in text response(s).</span>
</span><span id="check_SuspiciousCharacter-161"><a href="#check_SuspiciousCharacter-161"><span class="linenos">161</span></a>
</span><span id="check_SuspiciousCharacter-162"><a href="#check_SuspiciousCharacter-162"><span class="linenos">162</span></a><span class="sd">    Parameters:</span>
</span><span id="check_SuspiciousCharacter-163"><a href="#check_SuspiciousCharacter-163"><span class="linenos">163</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="check_SuspiciousCharacter-164"><a href="#check_SuspiciousCharacter-164"><span class="linenos">164</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="check_SuspiciousCharacter-165"><a href="#check_SuspiciousCharacter-165"><span class="linenos">165</span></a><span class="sd">        list_of_columns (List[str]) : List of column names with text responses.</span>
</span><span id="check_SuspiciousCharacter-166"><a href="#check_SuspiciousCharacter-166"><span class="linenos">166</span></a><span class="sd">        list_of_chars (List[str]) : List of suspicious characters to look for. Defaults to [&quot;\xa0&quot;].</span>
</span><span id="check_SuspiciousCharacter-167"><a href="#check_SuspiciousCharacter-167"><span class="linenos">167</span></a><span class="sd">            &quot;\xa0&quot;: ASCII for the non-breaking character.</span>
</span><span id="check_SuspiciousCharacter-168"><a href="#check_SuspiciousCharacter-168"><span class="linenos">168</span></a>
</span><span id="check_SuspiciousCharacter-169"><a href="#check_SuspiciousCharacter-169"><span class="linenos">169</span></a><span class="sd">    Returns:</span>
</span><span id="check_SuspiciousCharacter-170"><a href="#check_SuspiciousCharacter-170"><span class="linenos">170</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="check_SuspiciousCharacter-171"><a href="#check_SuspiciousCharacter-171"><span class="linenos">171</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_SuspiciousCharacter-172"><a href="#check_SuspiciousCharacter-172"><span class="linenos">172</span></a>    <span class="c1"># Convert missing data to empty string for character search</span>
</span><span id="check_SuspiciousCharacter-173"><a href="#check_SuspiciousCharacter-173"><span class="linenos">173</span></a>    <span class="n">list_of_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">list_of_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="check_SuspiciousCharacter-174"><a href="#check_SuspiciousCharacter-174"><span class="linenos">174</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns being checked for Suspicious Characters: </span><span class="si">{</span><span class="n">list_of_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="check_SuspiciousCharacter-175"><a href="#check_SuspiciousCharacter-175"><span class="linenos">175</span></a>    <span class="n">text_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">list_of_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="check_SuspiciousCharacter-176"><a href="#check_SuspiciousCharacter-176"><span class="linenos">176</span></a>    <span class="n">text_df</span> <span class="o">=</span> <span class="n">text_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="check_SuspiciousCharacter-177"><a href="#check_SuspiciousCharacter-177"><span class="linenos">177</span></a>    
</span><span id="check_SuspiciousCharacter-178"><a href="#check_SuspiciousCharacter-178"><span class="linenos">178</span></a>    <span class="c1"># Check for all characters across all columns</span>
</span><span id="check_SuspiciousCharacter-179"><a href="#check_SuspiciousCharacter-179"><span class="linenos">179</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">text_df</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">list_of_chars</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
</span><span id="check_SuspiciousCharacter-180"><a href="#check_SuspiciousCharacter-180"><span class="linenos">180</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="check_SuspiciousCharacter-181"><a href="#check_SuspiciousCharacter-181"><span class="linenos">181</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a flag column to the dataframe if there are suspicious characters (e.g., non-breaking character) in text response(s).</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with relevant columns.</li>
<li><strong>flag_name (str) :</strong>  Flag name.</li>
<li><strong>list_of_columns (List[str]) :</strong>  List of column names with text responses.</li>
<li><strong>list_of_chars (List[str]) :</strong>  List of suspicious characters to look for. Defaults to [""].
"": ASCII for the non-breaking character.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with flag.</p>
</blockquote>
</div>


                </section>
                <section id="check_SuspiciousName">
                            <input id="check_SuspiciousName-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_SuspiciousName</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">flag_name</span>,</span><span class="param">	<span class="n">column_first_name</span>,</span><span class="param">	<span class="n">column_last_name</span>,</span><span class="param">	<span class="n">min_word_length</span><span class="o">=</span><span class="mi">2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_SuspiciousName-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_SuspiciousName"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_SuspiciousName-183"><a href="#check_SuspiciousName-183"><span class="linenos">183</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_SuspiciousName-184"><a href="#check_SuspiciousName-184"><span class="linenos">184</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_SuspiciousName</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_first_name</span><span class="p">,</span> <span class="n">column_last_name</span><span class="p">,</span> <span class="n">min_word_length</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
</span><span id="check_SuspiciousName-185"><a href="#check_SuspiciousName-185"><span class="linenos">185</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_SuspiciousName-186"><a href="#check_SuspiciousName-186"><span class="linenos">186</span></a><span class="sd">    Adds a flag column to the dataframe for suspicious response to first name and last name columns.</span>
</span><span id="check_SuspiciousName-187"><a href="#check_SuspiciousName-187"><span class="linenos">187</span></a><span class="sd">    This flag only works if the first name and last name are collectde in two separate text responses. </span>
</span><span id="check_SuspiciousName-188"><a href="#check_SuspiciousName-188"><span class="linenos">188</span></a><span class="sd">    A response is considered suspicious if any one of the name fields repeats a word (while ignoring initials) from the other name field.</span>
</span><span id="check_SuspiciousName-189"><a href="#check_SuspiciousName-189"><span class="linenos">189</span></a>
</span><span id="check_SuspiciousName-190"><a href="#check_SuspiciousName-190"><span class="linenos">190</span></a><span class="sd">    Parameters:</span>
</span><span id="check_SuspiciousName-191"><a href="#check_SuspiciousName-191"><span class="linenos">191</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="check_SuspiciousName-192"><a href="#check_SuspiciousName-192"><span class="linenos">192</span></a><span class="sd">        flag_name (str) : Flag name. </span>
</span><span id="check_SuspiciousName-193"><a href="#check_SuspiciousName-193"><span class="linenos">193</span></a><span class="sd">        column_first_name (str) : Column name for the first name.</span>
</span><span id="check_SuspiciousName-194"><a href="#check_SuspiciousName-194"><span class="linenos">194</span></a><span class="sd">        column_last_name (str) : Column name for the last name.</span>
</span><span id="check_SuspiciousName-195"><a href="#check_SuspiciousName-195"><span class="linenos">195</span></a><span class="sd">        min_word_length (int) : Minimum length of a word to be considered for matching.</span>
</span><span id="check_SuspiciousName-196"><a href="#check_SuspiciousName-196"><span class="linenos">196</span></a><span class="sd">            Defaults to the recommended value of 2 to avoid initials. </span>
</span><span id="check_SuspiciousName-197"><a href="#check_SuspiciousName-197"><span class="linenos">197</span></a>
</span><span id="check_SuspiciousName-198"><a href="#check_SuspiciousName-198"><span class="linenos">198</span></a><span class="sd">    Returns:</span>
</span><span id="check_SuspiciousName-199"><a href="#check_SuspiciousName-199"><span class="linenos">199</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="check_SuspiciousName-200"><a href="#check_SuspiciousName-200"><span class="linenos">200</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_SuspiciousName-201"><a href="#check_SuspiciousName-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compare_names</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">min_word_length</span><span class="o">=</span><span class="n">min_word_length</span><span class="p">):</span>
</span><span id="check_SuspiciousName-202"><a href="#check_SuspiciousName-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_SuspiciousName-203"><a href="#check_SuspiciousName-203"><span class="linenos">203</span></a><span class="sd">        Search for common (min_word_length) letter words in first and last name ignoring the lettercase.</span>
</span><span id="check_SuspiciousName-204"><a href="#check_SuspiciousName-204"><span class="linenos">204</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="check_SuspiciousName-205"><a href="#check_SuspiciousName-205"><span class="linenos">205</span></a>        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">fr</span><span class="s2">&quot;(\w</span><span class="se">{{</span><span class="si">{</span><span class="n">min_word_length</span><span class="si">}</span><span class="s2">,</span><span class="se">}}</span><span class="s2">)&quot;</span>
</span><span id="check_SuspiciousName-206"><a href="#check_SuspiciousName-206"><span class="linenos">206</span></a>        
</span><span id="check_SuspiciousName-207"><a href="#check_SuspiciousName-207"><span class="linenos">207</span></a>        <span class="n">first_name_set</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="check_SuspiciousName-208"><a href="#check_SuspiciousName-208"><span class="linenos">208</span></a>        <span class="n">last_name_set</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="check_SuspiciousName-209"><a href="#check_SuspiciousName-209"><span class="linenos">209</span></a>        <span class="c1"># Strip and lowercase names for matching</span>
</span><span id="check_SuspiciousName-210"><a href="#check_SuspiciousName-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_first_name</span><span class="p">]):</span>
</span><span id="check_SuspiciousName-211"><a href="#check_SuspiciousName-211"><span class="linenos">211</span></a>            <span class="n">first_name</span> <span class="o">=</span>  <span class="n">row</span><span class="p">[</span><span class="n">column_first_name</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="check_SuspiciousName-212"><a href="#check_SuspiciousName-212"><span class="linenos">212</span></a>            <span class="n">first_name_set</span> <span class="o">=</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">first_name</span><span class="p">))</span>
</span><span id="check_SuspiciousName-213"><a href="#check_SuspiciousName-213"><span class="linenos">213</span></a>        
</span><span id="check_SuspiciousName-214"><a href="#check_SuspiciousName-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_last_name</span><span class="p">]):</span>
</span><span id="check_SuspiciousName-215"><a href="#check_SuspiciousName-215"><span class="linenos">215</span></a>            <span class="n">last_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">column_last_name</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="check_SuspiciousName-216"><a href="#check_SuspiciousName-216"><span class="linenos">216</span></a>            <span class="n">last_name_set</span> <span class="o">=</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">last_name</span><span class="p">))</span>
</span><span id="check_SuspiciousName-217"><a href="#check_SuspiciousName-217"><span class="linenos">217</span></a>
</span><span id="check_SuspiciousName-218"><a href="#check_SuspiciousName-218"><span class="linenos">218</span></a>        <span class="n">common_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">first_name_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">last_name_set</span><span class="p">)</span>
</span><span id="check_SuspiciousName-219"><a href="#check_SuspiciousName-219"><span class="linenos">219</span></a>        
</span><span id="check_SuspiciousName-220"><a href="#check_SuspiciousName-220"><span class="linenos">220</span></a>        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span> 
</span><span id="check_SuspiciousName-221"><a href="#check_SuspiciousName-221"><span class="linenos">221</span></a>    
</span><span id="check_SuspiciousName-222"><a href="#check_SuspiciousName-222"><span class="linenos">222</span></a>    <span class="c1"># Check for all characters in all columns</span>
</span><span id="check_SuspiciousName-223"><a href="#check_SuspiciousName-223"><span class="linenos">223</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">compare_names</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="check_SuspiciousName-224"><a href="#check_SuspiciousName-224"><span class="linenos">224</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a flag column to the dataframe for suspicious response to first name and last name columns.
This flag only works if the first name and last name are collectde in two separate text responses. 
A response is considered suspicious if any one of the name fields repeats a word (while ignoring initials) from the other name field.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with relevant columns.</li>
<li><strong>flag_name (str) :</strong>  Flag name. </li>
<li><strong>column_first_name (str) :</strong>  Column name for the first name.</li>
<li><strong>column_last_name (str) :</strong>  Column name for the last name.</li>
<li><strong>min_word_length (int) :</strong>  Minimum length of a word to be considered for matching.
Defaults to the recommended value of 2 to avoid initials. </li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with flag.</p>
</blockquote>
</div>


                </section>
                <section id="check_IPLocation">
                            <input id="check_IPLocation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_IPLocation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">flag_name</span>,</span><span class="param">	<span class="n">column_ip</span>,</span><span class="param">	<span class="n">target_region</span>,</span><span class="param">	<span class="n">flag_missing</span>,</span><span class="param">	<span class="n">region_level</span><span class="o">=</span><span class="s1">&#39;country&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_IPLocation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_IPLocation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_IPLocation-226"><a href="#check_IPLocation-226"><span class="linenos">226</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_IPLocation-227"><a href="#check_IPLocation-227"><span class="linenos">227</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_IPLocation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_ip</span><span class="p">,</span> <span class="n">target_region</span><span class="p">,</span> <span class="n">flag_missing</span><span class="p">,</span> <span class="n">region_level</span><span class="o">=</span><span class="s1">&#39;country&#39;</span><span class="p">):</span>
</span><span id="check_IPLocation-228"><a href="#check_IPLocation-228"><span class="linenos">228</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_IPLocation-229"><a href="#check_IPLocation-229"><span class="linenos">229</span></a><span class="sd">    Adds a region location column `IPLocation` and a flag column to the dataframe based on the IP address.</span>
</span><span id="check_IPLocation-230"><a href="#check_IPLocation-230"><span class="linenos">230</span></a>
</span><span id="check_IPLocation-231"><a href="#check_IPLocation-231"><span class="linenos">231</span></a><span class="sd">    Parameters:</span>
</span><span id="check_IPLocation-232"><a href="#check_IPLocation-232"><span class="linenos">232</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="check_IPLocation-233"><a href="#check_IPLocation-233"><span class="linenos">233</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="check_IPLocation-234"><a href="#check_IPLocation-234"><span class="linenos">234</span></a><span class="sd">        column_ip (str) : Column name for IP address. </span>
</span><span id="check_IPLocation-235"><a href="#check_IPLocation-235"><span class="linenos">235</span></a><span class="sd">        target_region (str) : Region name that should not be flagged. See the notes below for details. Defaults to &#39;country&#39;.</span>
</span><span id="check_IPLocation-236"><a href="#check_IPLocation-236"><span class="linenos">236</span></a><span class="sd">        flag_missing (bool) : Should missing data be flagged? True means missing data is flagged.</span>
</span><span id="check_IPLocation-237"><a href="#check_IPLocation-237"><span class="linenos">237</span></a><span class="sd">        region_level (str) : The geographic level of the region to check. Can be either &#39;country&#39;, &#39;state&#39;, or &#39;city&#39;. </span>
</span><span id="check_IPLocation-238"><a href="#check_IPLocation-238"><span class="linenos">238</span></a><span class="sd">            For example, &#39;country&#39; as &quot;US&quot;, &#39;state&#39; as &quot;California&quot;, and &#39;city&#39; as &quot;Mountain View&quot;.</span>
</span><span id="check_IPLocation-239"><a href="#check_IPLocation-239"><span class="linenos">239</span></a>
</span><span id="check_IPLocation-240"><a href="#check_IPLocation-240"><span class="linenos">240</span></a><span class="sd">    Returns:</span>
</span><span id="check_IPLocation-241"><a href="#check_IPLocation-241"><span class="linenos">241</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="check_IPLocation-242"><a href="#check_IPLocation-242"><span class="linenos">242</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_IPLocation-243"><a href="#check_IPLocation-243"><span class="linenos">243</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">geocoder</span>
</span><span id="check_IPLocation-244"><a href="#check_IPLocation-244"><span class="linenos">244</span></a>    <span class="k">if</span> <span class="n">region_level</span> <span class="o">==</span> <span class="s1">&#39;country&#39;</span><span class="p">:</span>
</span><span id="check_IPLocation-245"><a href="#check_IPLocation-245"><span class="linenos">245</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_ip</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">geocoder</span><span class="o">.</span><span class="n">ip</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">country</span><span class="p">)</span>
</span><span id="check_IPLocation-246"><a href="#check_IPLocation-246"><span class="linenos">246</span></a>    <span class="k">elif</span> <span class="n">region_level</span> <span class="o">==</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span>
</span><span id="check_IPLocation-247"><a href="#check_IPLocation-247"><span class="linenos">247</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_ip</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">geocoder</span><span class="o">.</span><span class="n">ip</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</span><span id="check_IPLocation-248"><a href="#check_IPLocation-248"><span class="linenos">248</span></a>    <span class="k">elif</span> <span class="n">region_level</span> <span class="o">==</span> <span class="s1">&#39;city&#39;</span><span class="p">:</span>
</span><span id="check_IPLocation-249"><a href="#check_IPLocation-249"><span class="linenos">249</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_ip</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">geocoder</span><span class="o">.</span><span class="n">ip</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">city</span><span class="p">)</span>
</span><span id="check_IPLocation-250"><a href="#check_IPLocation-250"><span class="linenos">250</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="check_IPLocation-251"><a href="#check_IPLocation-251"><span class="linenos">251</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The region_level should be either </span><span class="se">\&#39;</span><span class="s2">country</span><span class="se">\&#39;</span><span class="s2">, </span><span class="se">\&#39;</span><span class="s2">state</span><span class="se">\&#39;</span><span class="s2">, or </span><span class="se">\&#39;</span><span class="s2">city</span><span class="se">\&#39;</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="check_IPLocation-252"><a href="#check_IPLocation-252"><span class="linenos">252</span></a>
</span><span id="check_IPLocation-253"><a href="#check_IPLocation-253"><span class="linenos">253</span></a>    <span class="k">if</span> <span class="n">flag_missing</span><span class="p">:</span>
</span><span id="check_IPLocation-254"><a href="#check_IPLocation-254"><span class="linenos">254</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="check_IPLocation-255"><a href="#check_IPLocation-255"><span class="linenos">255</span></a>            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_region</span><span class="p">),</span> 
</span><span id="check_IPLocation-256"><a href="#check_IPLocation-256"><span class="linenos">256</span></a>            <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="check_IPLocation-257"><a href="#check_IPLocation-257"><span class="linenos">257</span></a>        <span class="p">)</span>
</span><span id="check_IPLocation-258"><a href="#check_IPLocation-258"><span class="linenos">258</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="check_IPLocation-259"><a href="#check_IPLocation-259"><span class="linenos">259</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="check_IPLocation-260"><a href="#check_IPLocation-260"><span class="linenos">260</span></a>            <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_region</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPLocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())),</span> 
</span><span id="check_IPLocation-261"><a href="#check_IPLocation-261"><span class="linenos">261</span></a>            <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="check_IPLocation-262"><a href="#check_IPLocation-262"><span class="linenos">262</span></a>        <span class="p">)</span>
</span><span id="check_IPLocation-263"><a href="#check_IPLocation-263"><span class="linenos">263</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="check_IPLocation-264"><a href="#check_IPLocation-264"><span class="linenos">264</span></a>
</span><span id="check_IPLocation-265"><a href="#check_IPLocation-265"><span class="linenos">265</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a region location column <code>IPLocation</code> and a flag column to the dataframe based on the IP address.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with relevant columns.</li>
<li><strong>flag_name (str) :</strong>  Flag name.</li>
<li><strong>column_ip (str) :</strong>  Column name for IP address. </li>
<li><strong>target_region (str) :</strong>  Region name that should not be flagged. See the notes below for details. Defaults to 'country'.</li>
<li><strong>flag_missing (bool) :</strong>  Should missing data be flagged? True means missing data is flagged.</li>
<li><strong>region_level (str) :</strong>  The geographic level of the region to check. Can be either 'country', 'state', or 'city'. 
For example, 'country' as "US", 'state' as "California", and 'city' as "Mountain View".</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with flag.</p>
</blockquote>
</div>


                </section>
                <section id="check_LatLongLocation">
                            <input id="check_LatLongLocation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_LatLongLocation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">flag_name</span>,</span><span class="param">	<span class="n">column_latitude</span>,</span><span class="param">	<span class="n">column_longitude</span>,</span><span class="param">	<span class="n">target_country</span>,</span><span class="param">	<span class="n">flag_missing</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_LatLongLocation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_LatLongLocation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_LatLongLocation-267"><a href="#check_LatLongLocation-267"><span class="linenos">267</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_LatLongLocation-268"><a href="#check_LatLongLocation-268"><span class="linenos">268</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_LatLongLocation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_latitude</span><span class="p">,</span> <span class="n">column_longitude</span><span class="p">,</span> <span class="n">target_country</span><span class="p">,</span> <span class="n">flag_missing</span><span class="p">):</span>
</span><span id="check_LatLongLocation-269"><a href="#check_LatLongLocation-269"><span class="linenos">269</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_LatLongLocation-270"><a href="#check_LatLongLocation-270"><span class="linenos">270</span></a><span class="sd">    Adds a country column `LatLongLocation` and a flag column to the dataframe based on Latitude-Longtitude.</span>
</span><span id="check_LatLongLocation-271"><a href="#check_LatLongLocation-271"><span class="linenos">271</span></a>
</span><span id="check_LatLongLocation-272"><a href="#check_LatLongLocation-272"><span class="linenos">272</span></a><span class="sd">    Parameters:</span>
</span><span id="check_LatLongLocation-273"><a href="#check_LatLongLocation-273"><span class="linenos">273</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="check_LatLongLocation-274"><a href="#check_LatLongLocation-274"><span class="linenos">274</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="check_LatLongLocation-275"><a href="#check_LatLongLocation-275"><span class="linenos">275</span></a><span class="sd">        column_latitude (str) : Column name for Latitude.</span>
</span><span id="check_LatLongLocation-276"><a href="#check_LatLongLocation-276"><span class="linenos">276</span></a><span class="sd">        column_longitude (str) : Column name for Longitude.</span>
</span><span id="check_LatLongLocation-277"><a href="#check_LatLongLocation-277"><span class="linenos">277</span></a><span class="sd">        target_country (str) : Country name that should not be flagged. Verifies against the country&#39;s full name (e.g., &quot;United States of America&quot;).</span>
</span><span id="check_LatLongLocation-278"><a href="#check_LatLongLocation-278"><span class="linenos">278</span></a><span class="sd">        flag_missing (bool) : Should missing data be flagged? True means missing data is flagged.</span>
</span><span id="check_LatLongLocation-279"><a href="#check_LatLongLocation-279"><span class="linenos">279</span></a>
</span><span id="check_LatLongLocation-280"><a href="#check_LatLongLocation-280"><span class="linenos">280</span></a><span class="sd">    Returns:</span>
</span><span id="check_LatLongLocation-281"><a href="#check_LatLongLocation-281"><span class="linenos">281</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="check_LatLongLocation-282"><a href="#check_LatLongLocation-282"><span class="linenos">282</span></a><span class="sd">    &quot;&quot;&quot;</span>    
</span><span id="check_LatLongLocation-283"><a href="#check_LatLongLocation-283"><span class="linenos">283</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span> <span class="c1"># LatLong</span>
</span><span id="check_LatLongLocation-284"><a href="#check_LatLongLocation-284"><span class="linenos">284</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span> <span class="c1"># LatLong</span>
</span><span id="check_LatLongLocation-285"><a href="#check_LatLongLocation-285"><span class="linenos">285</span></a>
</span><span id="check_LatLongLocation-286"><a href="#check_LatLongLocation-286"><span class="linenos">286</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">read_world_shape</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span id="check_LatLongLocation-287"><a href="#check_LatLongLocation-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_LatLongLocation-288"><a href="#check_LatLongLocation-288"><span class="linenos">288</span></a><span class="sd">        Returns a Shapely dataframe with geometries of all countries</span>
</span><span id="check_LatLongLocation-289"><a href="#check_LatLongLocation-289"><span class="linenos">289</span></a>
</span><span id="check_LatLongLocation-290"><a href="#check_LatLongLocation-290"><span class="linenos">290</span></a><span class="sd">        Parameters:</span>
</span><span id="check_LatLongLocation-291"><a href="#check_LatLongLocation-291"><span class="linenos">291</span></a><span class="sd">            fn (str) : Location of shape file.</span>
</span><span id="check_LatLongLocation-292"><a href="#check_LatLongLocation-292"><span class="linenos">292</span></a>
</span><span id="check_LatLongLocation-293"><a href="#check_LatLongLocation-293"><span class="linenos">293</span></a><span class="sd">        Returns:</span>
</span><span id="check_LatLongLocation-294"><a href="#check_LatLongLocation-294"><span class="linenos">294</span></a><span class="sd">            df (pd.DataFrame) : Dataframe with country &#39;name&#39;, &#39;iso3&#39;, and &#39;geometry&#39;.</span>
</span><span id="check_LatLongLocation-295"><a href="#check_LatLongLocation-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="check_LatLongLocation-296"><a href="#check_LatLongLocation-296"><span class="linenos">296</span></a>        <span class="c1"># Reading the shapefile</span>
</span><span id="check_LatLongLocation-297"><a href="#check_LatLongLocation-297"><span class="linenos">297</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> 
</span><span id="check_LatLongLocation-298"><a href="#check_LatLongLocation-298"><span class="linenos">298</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;iso3&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span> 
</span><span id="check_LatLongLocation-299"><a href="#check_LatLongLocation-299"><span class="linenos">299</span></a>    
</span><span id="check_LatLongLocation-300"><a href="#check_LatLongLocation-300"><span class="linenos">300</span></a>        <span class="c1"># Search priority for countries that appear in the data often (these can be modified to improve performance)</span>
</span><span id="check_LatLongLocation-301"><a href="#check_LatLongLocation-301"><span class="linenos">301</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># Creating additional column for counting country incidence</span>
</span><span id="check_LatLongLocation-302"><a href="#check_LatLongLocation-302"><span class="linenos">302</span></a>        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s2">&quot;United States of America&quot;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="check_LatLongLocation-303"><a href="#check_LatLongLocation-303"><span class="linenos">303</span></a>        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s2">&quot;China&quot;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="check_LatLongLocation-304"><a href="#check_LatLongLocation-304"><span class="linenos">304</span></a>        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s2">&quot;India&quot;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="check_LatLongLocation-305"><a href="#check_LatLongLocation-305"><span class="linenos">305</span></a>
</span><span id="check_LatLongLocation-306"><a href="#check_LatLongLocation-306"><span class="linenos">306</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;priority&#39;</span><span class="p">)</span>
</span><span id="check_LatLongLocation-307"><a href="#check_LatLongLocation-307"><span class="linenos">307</span></a>
</span><span id="check_LatLongLocation-308"><a href="#check_LatLongLocation-308"><span class="linenos">308</span></a>        <span class="k">return</span> <span class="n">df</span>
</span><span id="check_LatLongLocation-309"><a href="#check_LatLongLocation-309"><span class="linenos">309</span></a>    
</span><span id="check_LatLongLocation-310"><a href="#check_LatLongLocation-310"><span class="linenos">310</span></a>    <span class="c1"># Read world shapefile data</span>
</span><span id="check_LatLongLocation-311"><a href="#check_LatLongLocation-311"><span class="linenos">311</span></a>    <span class="n">var_data</span> <span class="o">=</span> <span class="s2">&quot;world_shape_file&quot;</span>
</span><span id="check_LatLongLocation-312"><a href="#check_LatLongLocation-312"><span class="linenos">312</span></a>    <span class="k">if</span> <span class="n">var_data</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
</span><span id="check_LatLongLocation-313"><a href="#check_LatLongLocation-313"><span class="linenos">313</span></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
</span><span id="check_LatLongLocation-314"><a href="#check_LatLongLocation-314"><span class="linenos">314</span></a>            <span class="sa">f</span><span class="s2">&quot;&#39;world_shape_file&#39; path not found in user_input in the parameters file. &quot;</span>
</span><span id="check_LatLongLocation-315"><a href="#check_LatLongLocation-315"><span class="linenos">315</span></a>            <span class="sa">f</span><span class="s2">&quot;This shapefile is required to get country&#39;s name from latitude-longitude.&quot;</span>
</span><span id="check_LatLongLocation-316"><a href="#check_LatLongLocation-316"><span class="linenos">316</span></a>        <span class="p">)</span>
</span><span id="check_LatLongLocation-317"><a href="#check_LatLongLocation-317"><span class="linenos">317</span></a>    <span class="n">fn</span> <span class="o">=</span> <span class="n">filepaths</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filepaths</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">var_data</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="check_LatLongLocation-318"><a href="#check_LatLongLocation-318"><span class="linenos">318</span></a>    <span class="n">df_world</span> <span class="o">=</span> <span class="n">read_world_shape</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="c1"># Need this for get_latlong_country()</span>
</span><span id="check_LatLongLocation-319"><a href="#check_LatLongLocation-319"><span class="linenos">319</span></a>
</span><span id="check_LatLongLocation-320"><a href="#check_LatLongLocation-320"><span class="linenos">320</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_latlong_country</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">long</span><span class="p">):</span>
</span><span id="check_LatLongLocation-321"><a href="#check_LatLongLocation-321"><span class="linenos">321</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_LatLongLocation-322"><a href="#check_LatLongLocation-322"><span class="linenos">322</span></a><span class="sd">        Returns the country and state of the given lat-long. Requires `df_world` dataframe.</span>
</span><span id="check_LatLongLocation-323"><a href="#check_LatLongLocation-323"><span class="linenos">323</span></a>
</span><span id="check_LatLongLocation-324"><a href="#check_LatLongLocation-324"><span class="linenos">324</span></a><span class="sd">        Parameters:</span>
</span><span id="check_LatLongLocation-325"><a href="#check_LatLongLocation-325"><span class="linenos">325</span></a><span class="sd">            lat (float) : Latitude in degrees.</span>
</span><span id="check_LatLongLocation-326"><a href="#check_LatLongLocation-326"><span class="linenos">326</span></a><span class="sd">            long (float) : Longitude in degrees.</span>
</span><span id="check_LatLongLocation-327"><a href="#check_LatLongLocation-327"><span class="linenos">327</span></a>
</span><span id="check_LatLongLocation-328"><a href="#check_LatLongLocation-328"><span class="linenos">328</span></a><span class="sd">        Returns:</span>
</span><span id="check_LatLongLocation-329"><a href="#check_LatLongLocation-329"><span class="linenos">329</span></a><span class="sd">            country (str) : Country name. </span>
</span><span id="check_LatLongLocation-330"><a href="#check_LatLongLocation-330"><span class="linenos">330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="check_LatLongLocation-331"><a href="#check_LatLongLocation-331"><span class="linenos">331</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">long</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
</span><span id="check_LatLongLocation-332"><a href="#check_LatLongLocation-332"><span class="linenos">332</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="check_LatLongLocation-333"><a href="#check_LatLongLocation-333"><span class="linenos">333</span></a>        <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">long</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="c1"># Note that it is long-lat in Point()</span>
</span><span id="check_LatLongLocation-334"><a href="#check_LatLongLocation-334"><span class="linenos">334</span></a>
</span><span id="check_LatLongLocation-335"><a href="#check_LatLongLocation-335"><span class="linenos">335</span></a>        <span class="c1"># Use the spatial index to speed up the querying</span>
</span><span id="check_LatLongLocation-336"><a href="#check_LatLongLocation-336"><span class="linenos">336</span></a>        <span class="n">possible_matches_index</span> <span class="o">=</span> <span class="n">df_world</span><span class="o">.</span><span class="n">sindex</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">)</span>
</span><span id="check_LatLongLocation-337"><a href="#check_LatLongLocation-337"><span class="linenos">337</span></a>        <span class="n">possible_matches</span> <span class="o">=</span> <span class="n">df_world</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">possible_matches_index</span><span class="p">]</span>
</span><span id="check_LatLongLocation-338"><a href="#check_LatLongLocation-338"><span class="linenos">338</span></a>        
</span><span id="check_LatLongLocation-339"><a href="#check_LatLongLocation-339"><span class="linenos">339</span></a>        <span class="c1"># Searching for the point in country&#39;s geometry</span>
</span><span id="check_LatLongLocation-340"><a href="#check_LatLongLocation-340"><span class="linenos">340</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">possible_matches</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="check_LatLongLocation-341"><a href="#check_LatLongLocation-341"><span class="linenos">341</span></a>            <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]):</span>
</span><span id="check_LatLongLocation-342"><a href="#check_LatLongLocation-342"><span class="linenos">342</span></a>                <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="c1"># Country</span>
</span><span id="check_LatLongLocation-343"><a href="#check_LatLongLocation-343"><span class="linenos">343</span></a>
</span><span id="check_LatLongLocation-344"><a href="#check_LatLongLocation-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="check_LatLongLocation-345"><a href="#check_LatLongLocation-345"><span class="linenos">345</span></a>    
</span><span id="check_LatLongLocation-346"><a href="#check_LatLongLocation-346"><span class="linenos">346</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;LatLongLocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="check_LatLongLocation-347"><a href="#check_LatLongLocation-347"><span class="linenos">347</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_latlong_country</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">column_latitude</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">column_longitude</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span id="check_LatLongLocation-348"><a href="#check_LatLongLocation-348"><span class="linenos">348</span></a>    <span class="p">)</span>
</span><span id="check_LatLongLocation-349"><a href="#check_LatLongLocation-349"><span class="linenos">349</span></a>    
</span><span id="check_LatLongLocation-350"><a href="#check_LatLongLocation-350"><span class="linenos">350</span></a>    <span class="k">if</span> <span class="n">flag_missing</span><span class="p">:</span>
</span><span id="check_LatLongLocation-351"><a href="#check_LatLongLocation-351"><span class="linenos">351</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="check_LatLongLocation-352"><a href="#check_LatLongLocation-352"><span class="linenos">352</span></a>            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;LatLongLocation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_country</span><span class="p">),</span> 
</span><span id="check_LatLongLocation-353"><a href="#check_LatLongLocation-353"><span class="linenos">353</span></a>            <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="check_LatLongLocation-354"><a href="#check_LatLongLocation-354"><span class="linenos">354</span></a>        <span class="p">)</span>
</span><span id="check_LatLongLocation-355"><a href="#check_LatLongLocation-355"><span class="linenos">355</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="check_LatLongLocation-356"><a href="#check_LatLongLocation-356"><span class="linenos">356</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="check_LatLongLocation-357"><a href="#check_LatLongLocation-357"><span class="linenos">357</span></a>            <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;LatLongLocation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_country</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;LatLongLocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())),</span> 
</span><span id="check_LatLongLocation-358"><a href="#check_LatLongLocation-358"><span class="linenos">358</span></a>            <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="check_LatLongLocation-359"><a href="#check_LatLongLocation-359"><span class="linenos">359</span></a>        <span class="p">)</span>
</span><span id="check_LatLongLocation-360"><a href="#check_LatLongLocation-360"><span class="linenos">360</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="check_LatLongLocation-361"><a href="#check_LatLongLocation-361"><span class="linenos">361</span></a>        
</span><span id="check_LatLongLocation-362"><a href="#check_LatLongLocation-362"><span class="linenos">362</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a country column <code>LatLongLocation</code> and a flag column to the dataframe based on Latitude-Longtitude.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with relevant columns.</li>
<li><strong>flag_name (str) :</strong>  Flag name.</li>
<li><strong>column_latitude (str) :</strong>  Column name for Latitude.</li>
<li><strong>column_longitude (str) :</strong>  Column name for Longitude.</li>
<li><strong>target_country (str) :</strong>  Country name that should not be flagged. Verifies against the country's full name (e.g., "United States of America").</li>
<li><strong>flag_missing (bool) :</strong>  Should missing data be flagged? True means missing data is flagged.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with flag.</p>
</blockquote>
</div>


                </section>
                <section id="check_MultipleIPAttempts">
                            <input id="check_MultipleIPAttempts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_MultipleIPAttempts</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">flag_name</span>,</span><span class="param">	<span class="n">column_ip</span>,</span><span class="param">	<span class="n">column_success</span>,</span><span class="param">	<span class="n">num_attempts_lower</span>,</span><span class="param">	<span class="n">num_attempts_upper</span><span class="o">=</span><span class="n">inf</span>,</span><span class="param">	<span class="n">attempt_type</span><span class="o">=</span><span class="s1">&#39;successful&#39;</span>,</span><span class="param">	<span class="n">column_terminate</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_MultipleIPAttempts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_MultipleIPAttempts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_MultipleIPAttempts-366"><a href="#check_MultipleIPAttempts-366"><span class="linenos">366</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_MultipleIPAttempts-367"><a href="#check_MultipleIPAttempts-367"><span class="linenos">367</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_MultipleIPAttempts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_ip</span><span class="p">,</span> <span class="n">column_success</span><span class="p">,</span> <span class="n">num_attempts_lower</span><span class="p">,</span> 
</span><span id="check_MultipleIPAttempts-368"><a href="#check_MultipleIPAttempts-368"><span class="linenos">368</span></a>                            <span class="n">num_attempts_upper</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">attempt_type</span><span class="o">=</span><span class="s1">&#39;successful&#39;</span><span class="p">,</span> <span class="n">column_terminate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="check_MultipleIPAttempts-369"><a href="#check_MultipleIPAttempts-369"><span class="linenos">369</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_MultipleIPAttempts-370"><a href="#check_MultipleIPAttempts-370"><span class="linenos">370</span></a><span class="sd">    Adds a flag column to the dataframe for multiple attempts from the same IP network (i.e., the first three octets; e.g., 8.8.8).</span>
</span><span id="check_MultipleIPAttempts-371"><a href="#check_MultipleIPAttempts-371"><span class="linenos">371</span></a><span class="sd">    Also adds a `IPNetwork` columns to the dataframe. </span>
</span><span id="check_MultipleIPAttempts-372"><a href="#check_MultipleIPAttempts-372"><span class="linenos">372</span></a><span class="sd">    The function can be defined to provide a lower bound and an upper bound to count the attempts. </span>
</span><span id="check_MultipleIPAttempts-373"><a href="#check_MultipleIPAttempts-373"><span class="linenos">373</span></a><span class="sd">    It can also be modified to consider a specific type of attempt (e.g., successful or incomplete). </span>
</span><span id="check_MultipleIPAttempts-374"><a href="#check_MultipleIPAttempts-374"><span class="linenos">374</span></a>
</span><span id="check_MultipleIPAttempts-375"><a href="#check_MultipleIPAttempts-375"><span class="linenos">375</span></a><span class="sd">    Parameters:</span>
</span><span id="check_MultipleIPAttempts-376"><a href="#check_MultipleIPAttempts-376"><span class="linenos">376</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="check_MultipleIPAttempts-377"><a href="#check_MultipleIPAttempts-377"><span class="linenos">377</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="check_MultipleIPAttempts-378"><a href="#check_MultipleIPAttempts-378"><span class="linenos">378</span></a><span class="sd">        column_ip (str) : Column name with IP address.</span>
</span><span id="check_MultipleIPAttempts-379"><a href="#check_MultipleIPAttempts-379"><span class="linenos">379</span></a><span class="sd">        column_success (str) : Column name with a non-empty response treated as a successful attempt.</span>
</span><span id="check_MultipleIPAttempts-380"><a href="#check_MultipleIPAttempts-380"><span class="linenos">380</span></a><span class="sd">        num_attempts_lower (int) : Minimum number of attempts from the same IP to be flagged (&gt;=).</span>
</span><span id="check_MultipleIPAttempts-381"><a href="#check_MultipleIPAttempts-381"><span class="linenos">381</span></a><span class="sd">        num_attempts_upper (int) : Maximum number of attempts from the same IP to be flagged (&lt;=).</span>
</span><span id="check_MultipleIPAttempts-382"><a href="#check_MultipleIPAttempts-382"><span class="linenos">382</span></a><span class="sd">            Defaults to np.inf.</span>
</span><span id="check_MultipleIPAttempts-383"><a href="#check_MultipleIPAttempts-383"><span class="linenos">383</span></a><span class="sd">        attempt_type (str) : Type of attempt to flag. Defaults to &#39;successful&#39;.</span>
</span><span id="check_MultipleIPAttempts-384"><a href="#check_MultipleIPAttempts-384"><span class="linenos">384</span></a><span class="sd">            &#39;successful&#39; : attempts have a response for the `column_success` question.</span>
</span><span id="check_MultipleIPAttempts-385"><a href="#check_MultipleIPAttempts-385"><span class="linenos">385</span></a><span class="sd">            &#39;incomplete&#39; : attempts have no response for the `column_success` question and has no terminate flag.</span>
</span><span id="check_MultipleIPAttempts-386"><a href="#check_MultipleIPAttempts-386"><span class="linenos">386</span></a><span class="sd">            &#39;failed&#39; : attempts have no response for the `column_success` question and has a terminate flag.</span>
</span><span id="check_MultipleIPAttempts-387"><a href="#check_MultipleIPAttempts-387"><span class="linenos">387</span></a><span class="sd">            &#39;all&#39; : attempts irrespective of if it is successful or not.</span>
</span><span id="check_MultipleIPAttempts-388"><a href="#check_MultipleIPAttempts-388"><span class="linenos">388</span></a><span class="sd">        column_terminate (str) : Column name with terminate flag. Optional for &#39;successful&#39; attempt.</span>
</span><span id="check_MultipleIPAttempts-389"><a href="#check_MultipleIPAttempts-389"><span class="linenos">389</span></a>
</span><span id="check_MultipleIPAttempts-390"><a href="#check_MultipleIPAttempts-390"><span class="linenos">390</span></a><span class="sd">    Returns:</span>
</span><span id="check_MultipleIPAttempts-391"><a href="#check_MultipleIPAttempts-391"><span class="linenos">391</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="check_MultipleIPAttempts-392"><a href="#check_MultipleIPAttempts-392"><span class="linenos">392</span></a>
</span><span id="check_MultipleIPAttempts-393"><a href="#check_MultipleIPAttempts-393"><span class="linenos">393</span></a><span class="sd">    Notes:</span>
</span><span id="check_MultipleIPAttempts-394"><a href="#check_MultipleIPAttempts-394"><span class="linenos">394</span></a><span class="sd">        Qualtrics can recode &quot;Seen but unanswered questions&quot; as -99. These are treated as &quot;successful&quot;.</span>
</span><span id="check_MultipleIPAttempts-395"><a href="#check_MultipleIPAttempts-395"><span class="linenos">395</span></a><span class="sd">        Qualtrics `Q_TerminateFlag` column marks unsuccessful responses as &quot;Screened&quot; or &quot;QuotaMet&quot;.</span>
</span><span id="check_MultipleIPAttempts-396"><a href="#check_MultipleIPAttempts-396"><span class="linenos">396</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_MultipleIPAttempts-397"><a href="#check_MultipleIPAttempts-397"><span class="linenos">397</span></a>    
</span><span id="check_MultipleIPAttempts-398"><a href="#check_MultipleIPAttempts-398"><span class="linenos">398</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">count_attempts</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span><span id="check_MultipleIPAttempts-399"><a href="#check_MultipleIPAttempts-399"><span class="linenos">399</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_MultipleIPAttempts-400"><a href="#check_MultipleIPAttempts-400"><span class="linenos">400</span></a><span class="sd">        Adds flags if number of attempts exceed the maximum attempt type</span>
</span><span id="check_MultipleIPAttempts-401"><a href="#check_MultipleIPAttempts-401"><span class="linenos">401</span></a><span class="sd">            </span>
</span><span id="check_MultipleIPAttempts-402"><a href="#check_MultipleIPAttempts-402"><span class="linenos">402</span></a><span class="sd">        Parameters:</span>
</span><span id="check_MultipleIPAttempts-403"><a href="#check_MultipleIPAttempts-403"><span class="linenos">403</span></a><span class="sd">            group (pd.groupby): Group with the same IP network.</span>
</span><span id="check_MultipleIPAttempts-404"><a href="#check_MultipleIPAttempts-404"><span class="linenos">404</span></a><span class="sd">            </span>
</span><span id="check_MultipleIPAttempts-405"><a href="#check_MultipleIPAttempts-405"><span class="linenos">405</span></a><span class="sd">        Returns:</span>
</span><span id="check_MultipleIPAttempts-406"><a href="#check_MultipleIPAttempts-406"><span class="linenos">406</span></a><span class="sd">            group (pd.groupby): Group with the attempt type flag.</span>
</span><span id="check_MultipleIPAttempts-407"><a href="#check_MultipleIPAttempts-407"><span class="linenos">407</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="check_MultipleIPAttempts-408"><a href="#check_MultipleIPAttempts-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="n">attempt_type</span> <span class="o">==</span> <span class="s1">&#39;successful&#39;</span><span class="p">:</span>
</span><span id="check_MultipleIPAttempts-409"><a href="#check_MultipleIPAttempts-409"><span class="linenos">409</span></a>            <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">column_success</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="check_MultipleIPAttempts-410"><a href="#check_MultipleIPAttempts-410"><span class="linenos">410</span></a>        <span class="k">elif</span> <span class="n">attempt_type</span> <span class="o">==</span> <span class="s1">&#39;incomplete&#39;</span><span class="p">:</span>
</span><span id="check_MultipleIPAttempts-411"><a href="#check_MultipleIPAttempts-411"><span class="linenos">411</span></a>            <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">column_success</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">group</span><span class="p">[</span><span class="n">column_terminate</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="check_MultipleIPAttempts-412"><a href="#check_MultipleIPAttempts-412"><span class="linenos">412</span></a>        <span class="k">elif</span> <span class="n">attempt_type</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span>
</span><span id="check_MultipleIPAttempts-413"><a href="#check_MultipleIPAttempts-413"><span class="linenos">413</span></a>            <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">column_success</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">group</span><span class="p">[</span><span class="n">column_terminate</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="check_MultipleIPAttempts-414"><a href="#check_MultipleIPAttempts-414"><span class="linenos">414</span></a>        <span class="k">elif</span> <span class="n">attempt_type</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
</span><span id="check_MultipleIPAttempts-415"><a href="#check_MultipleIPAttempts-415"><span class="linenos">415</span></a>            <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span>
</span><span id="check_MultipleIPAttempts-416"><a href="#check_MultipleIPAttempts-416"><span class="linenos">416</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="check_MultipleIPAttempts-417"><a href="#check_MultipleIPAttempts-417"><span class="linenos">417</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid attempt_type: </span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="check_MultipleIPAttempts-418"><a href="#check_MultipleIPAttempts-418"><span class="linenos">418</span></a>            
</span><span id="check_MultipleIPAttempts-419"><a href="#check_MultipleIPAttempts-419"><span class="linenos">419</span></a>        <span class="n">group</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="check_MultipleIPAttempts-420"><a href="#check_MultipleIPAttempts-420"><span class="linenos">420</span></a>            <span class="p">((</span><span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">num_attempts_lower</span><span class="p">)</span> 
</span><span id="check_MultipleIPAttempts-421"><a href="#check_MultipleIPAttempts-421"><span class="linenos">421</span></a>            <span class="o">&amp;</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;num_attempts_</span><span class="si">{</span><span class="n">attempt_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">num_attempts_upper</span><span class="p">)),</span>
</span><span id="check_MultipleIPAttempts-422"><a href="#check_MultipleIPAttempts-422"><span class="linenos">422</span></a>            <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="check_MultipleIPAttempts-423"><a href="#check_MultipleIPAttempts-423"><span class="linenos">423</span></a>        <span class="p">)</span>
</span><span id="check_MultipleIPAttempts-424"><a href="#check_MultipleIPAttempts-424"><span class="linenos">424</span></a>        
</span><span id="check_MultipleIPAttempts-425"><a href="#check_MultipleIPAttempts-425"><span class="linenos">425</span></a>        <span class="k">return</span> <span class="n">group</span>
</span><span id="check_MultipleIPAttempts-426"><a href="#check_MultipleIPAttempts-426"><span class="linenos">426</span></a>    
</span><span id="check_MultipleIPAttempts-427"><a href="#check_MultipleIPAttempts-427"><span class="linenos">427</span></a>    <span class="c1"># Add a column for the network portion of the IP address (ignoring the host/device portion)</span>
</span><span id="check_MultipleIPAttempts-428"><a href="#check_MultipleIPAttempts-428"><span class="linenos">428</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IPNetwork&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_ip</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ip</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="check_MultipleIPAttempts-429"><a href="#check_MultipleIPAttempts-429"><span class="linenos">429</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;IPNetwork&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">count_attempts</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="check_MultipleIPAttempts-430"><a href="#check_MultipleIPAttempts-430"><span class="linenos">430</span></a>    
</span><span id="check_MultipleIPAttempts-431"><a href="#check_MultipleIPAttempts-431"><span class="linenos">431</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a flag column to the dataframe for multiple attempts from the same IP network (i.e., the first three octets; e.g., 8.8.8).
Also adds a <code>IPNetwork</code> columns to the dataframe. 
The function can be defined to provide a lower bound and an upper bound to count the attempts. 
It can also be modified to consider a specific type of attempt (e.g., successful or incomplete). </p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with relevant columns.</li>
<li><strong>flag_name (str) :</strong>  Flag name.</li>
<li><strong>column_ip (str) :</strong>  Column name with IP address.</li>
<li><strong>column_success (str) :</strong>  Column name with a non-empty response treated as a successful attempt.</li>
<li><strong>num_attempts_lower (int) :</strong>  Minimum number of attempts from the same IP to be flagged (&gt;=).</li>
<li><strong>num_attempts_upper (int) :</strong>  Maximum number of attempts from the same IP to be flagged (&lt;=).
Defaults to np.inf.</li>
<li><strong>attempt_type (str) :</strong>  Type of attempt to flag. Defaults to 'successful'.
'successful' : attempts have a response for the <code>column_success</code> question.
'incomplete' : attempts have no response for the <code>column_success</code> question and has no terminate flag.
'failed' : attempts have no response for the <code>column_success</code> question and has a terminate flag.
'all' : attempts irrespective of if it is successful or not.</li>
<li><strong>column_terminate (str) :</strong>  Column name with terminate flag. Optional for 'successful' attempt.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with flag.</p>
</blockquote>

<h6 id="notes">Notes:</h6>

<blockquote>
  <p>Qualtrics can recode "Seen but unanswered questions" as -99. These are treated as "successful".
  Qualtrics <code>Q_TerminateFlag</code> column marks unsuccessful responses as "Screened" or "QuotaMet".</p>
</blockquote>
</div>


                </section>
                <section id="check_BurstResponses">
                            <input id="check_BurstResponses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_BurstResponses</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">flag_name</span>,</span><span class="param">	<span class="n">column_start_time</span>,</span><span class="param">	<span class="n">column_duration</span>,</span><span class="param">	<span class="n">max_start_time_difference</span>,</span><span class="param">	<span class="n">max_duration_difference</span>,</span><span class="param">	<span class="n">unflag_start_time_difference</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">unflag_duration_difference</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_BurstResponses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_BurstResponses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_BurstResponses-433"><a href="#check_BurstResponses-433"><span class="linenos">433</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_BurstResponses-434"><a href="#check_BurstResponses-434"><span class="linenos">434</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_BurstResponses</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">column_start_time</span><span class="p">,</span> <span class="n">column_duration</span><span class="p">,</span>
</span><span id="check_BurstResponses-435"><a href="#check_BurstResponses-435"><span class="linenos">435</span></a>                        <span class="n">max_start_time_difference</span><span class="p">,</span> <span class="n">max_duration_difference</span><span class="p">,</span> 
</span><span id="check_BurstResponses-436"><a href="#check_BurstResponses-436"><span class="linenos">436</span></a>                        <span class="n">unflag_start_time_difference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unflag_duration_difference</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="check_BurstResponses-437"><a href="#check_BurstResponses-437"><span class="linenos">437</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_BurstResponses-438"><a href="#check_BurstResponses-438"><span class="linenos">438</span></a><span class="sd">    Adds a flag column to the dataframe for burst of responses with similar start times and durations.</span>
</span><span id="check_BurstResponses-439"><a href="#check_BurstResponses-439"><span class="linenos">439</span></a><span class="sd">    Adds an additional column with number of burst responses `NumBurstResponses`.</span>
</span><span id="check_BurstResponses-440"><a href="#check_BurstResponses-440"><span class="linenos">440</span></a><span class="sd">    This method implements a lower bound and an upper bound for start time and duration differences to allow for graded flagging. </span>
</span><span id="check_BurstResponses-441"><a href="#check_BurstResponses-441"><span class="linenos">441</span></a>
</span><span id="check_BurstResponses-442"><a href="#check_BurstResponses-442"><span class="linenos">442</span></a><span class="sd">    Parameters:</span>
</span><span id="check_BurstResponses-443"><a href="#check_BurstResponses-443"><span class="linenos">443</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="check_BurstResponses-444"><a href="#check_BurstResponses-444"><span class="linenos">444</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="check_BurstResponses-445"><a href="#check_BurstResponses-445"><span class="linenos">445</span></a><span class="sd">        column_start_time (str) : Column name for survey start date and time.</span>
</span><span id="check_BurstResponses-446"><a href="#check_BurstResponses-446"><span class="linenos">446</span></a><span class="sd">        column_duration (str) : Column name for survey duration.</span>
</span><span id="check_BurstResponses-447"><a href="#check_BurstResponses-447"><span class="linenos">447</span></a><span class="sd">        max_start_time_difference (int) : Maximum absolute difference between start times.</span>
</span><span id="check_BurstResponses-448"><a href="#check_BurstResponses-448"><span class="linenos">448</span></a><span class="sd">        max_duration_difference (int) : Maximum absolute difference between survey durations.</span>
</span><span id="check_BurstResponses-449"><a href="#check_BurstResponses-449"><span class="linenos">449</span></a><span class="sd">        unflag_start_time_difference (int) : Maximum start time difference for not flagging the responses.</span>
</span><span id="check_BurstResponses-450"><a href="#check_BurstResponses-450"><span class="linenos">450</span></a><span class="sd">        unflag_duration_difference (int) : Maximum duration difference for not flagging the responses.</span>
</span><span id="check_BurstResponses-451"><a href="#check_BurstResponses-451"><span class="linenos">451</span></a><span class="sd">        </span>
</span><span id="check_BurstResponses-452"><a href="#check_BurstResponses-452"><span class="linenos">452</span></a><span class="sd">    Returns:</span>
</span><span id="check_BurstResponses-453"><a href="#check_BurstResponses-453"><span class="linenos">453</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="check_BurstResponses-454"><a href="#check_BurstResponses-454"><span class="linenos">454</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_BurstResponses-455"><a href="#check_BurstResponses-455"><span class="linenos">455</span></a>    <span class="c1"># Copying dataframe and converting start time column to datetime </span>
</span><span id="check_BurstResponses-456"><a href="#check_BurstResponses-456"><span class="linenos">456</span></a>    <span class="n">nearby_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">column_start_time</span><span class="p">,</span> <span class="n">column_duration</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="check_BurstResponses-457"><a href="#check_BurstResponses-457"><span class="linenos">457</span></a>    <span class="n">nearby_df</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">nearby_df</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">])</span>
</span><span id="check_BurstResponses-458"><a href="#check_BurstResponses-458"><span class="linenos">458</span></a>    
</span><span id="check_BurstResponses-459"><a href="#check_BurstResponses-459"><span class="linenos">459</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_num_responses</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">max_start</span><span class="p">,</span> <span class="n">max_duration</span><span class="p">):</span>
</span><span id="check_BurstResponses-460"><a href="#check_BurstResponses-460"><span class="linenos">460</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_BurstResponses-461"><a href="#check_BurstResponses-461"><span class="linenos">461</span></a><span class="sd">        Returns indices of all rows that are within the maximum start time and duration threshold for the input row.</span>
</span><span id="check_BurstResponses-462"><a href="#check_BurstResponses-462"><span class="linenos">462</span></a><span class="sd">            </span>
</span><span id="check_BurstResponses-463"><a href="#check_BurstResponses-463"><span class="linenos">463</span></a><span class="sd">        Parameters:</span>
</span><span id="check_BurstResponses-464"><a href="#check_BurstResponses-464"><span class="linenos">464</span></a><span class="sd">            row (pd.Series): A single row of the dataframe. </span>
</span><span id="check_BurstResponses-465"><a href="#check_BurstResponses-465"><span class="linenos">465</span></a><span class="sd">            max_start_time (int) : Maximum absolute difference between start times.</span>
</span><span id="check_BurstResponses-466"><a href="#check_BurstResponses-466"><span class="linenos">466</span></a><span class="sd">            max_duration (int) : Maximum absolute difference between survey durations.</span>
</span><span id="check_BurstResponses-467"><a href="#check_BurstResponses-467"><span class="linenos">467</span></a><span class="sd">            </span>
</span><span id="check_BurstResponses-468"><a href="#check_BurstResponses-468"><span class="linenos">468</span></a><span class="sd">        Returns:</span>
</span><span id="check_BurstResponses-469"><a href="#check_BurstResponses-469"><span class="linenos">469</span></a><span class="sd">            num_responses (int) : Number of nearby responses near the input row.</span>
</span><span id="check_BurstResponses-470"><a href="#check_BurstResponses-470"><span class="linenos">470</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="check_BurstResponses-471"><a href="#check_BurstResponses-471"><span class="linenos">471</span></a>        <span class="c1"># Start time and duration must exist (may have missing data if multiple surveys are merged)</span>
</span><span id="check_BurstResponses-472"><a href="#check_BurstResponses-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column_duration</span><span class="p">]):</span>
</span><span id="check_BurstResponses-473"><a href="#check_BurstResponses-473"><span class="linenos">473</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="check_BurstResponses-474"><a href="#check_BurstResponses-474"><span class="linenos">474</span></a>        
</span><span id="check_BurstResponses-475"><a href="#check_BurstResponses-475"><span class="linenos">475</span></a>        <span class="n">diff_start_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">nearby_df</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="n">column_start_time</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
</span><span id="check_BurstResponses-476"><a href="#check_BurstResponses-476"><span class="linenos">476</span></a>        <span class="n">diff_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nearby_df</span><span class="p">[</span><span class="n">column_duration</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="n">column_duration</span><span class="p">])</span>
</span><span id="check_BurstResponses-477"><a href="#check_BurstResponses-477"><span class="linenos">477</span></a>        
</span><span id="check_BurstResponses-478"><a href="#check_BurstResponses-478"><span class="linenos">478</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">diff_start_time</span> <span class="o">&lt;=</span> <span class="n">max_start</span><span class="p">)</span> 
</span><span id="check_BurstResponses-479"><a href="#check_BurstResponses-479"><span class="linenos">479</span></a>                <span class="o">&amp;</span> <span class="p">(</span><span class="n">diff_duration</span> <span class="o">&lt;=</span> <span class="n">max_duration</span><span class="p">))</span>
</span><span id="check_BurstResponses-480"><a href="#check_BurstResponses-480"><span class="linenos">480</span></a>        
</span><span id="check_BurstResponses-481"><a href="#check_BurstResponses-481"><span class="linenos">481</span></a>        <span class="n">idxs</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="c1"># Get indexes of nearby responses</span>
</span><span id="check_BurstResponses-482"><a href="#check_BurstResponses-482"><span class="linenos">482</span></a>        <span class="c1"># idxs can be empty if min_start_time_difference != 0</span>
</span><span id="check_BurstResponses-483"><a href="#check_BurstResponses-483"><span class="linenos">483</span></a>        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
</span><span id="check_BurstResponses-484"><a href="#check_BurstResponses-484"><span class="linenos">484</span></a>            <span class="n">idxs</span> <span class="o">=</span> <span class="n">idxs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="c1"># Remove self index</span>
</span><span id="check_BurstResponses-485"><a href="#check_BurstResponses-485"><span class="linenos">485</span></a>            
</span><span id="check_BurstResponses-486"><a href="#check_BurstResponses-486"><span class="linenos">486</span></a>        <span class="n">num_responses</span> <span class="o">=</span> <span class="n">idxs</span><span class="o">.</span><span class="n">size</span>
</span><span id="check_BurstResponses-487"><a href="#check_BurstResponses-487"><span class="linenos">487</span></a>        <span class="k">return</span> <span class="n">num_responses</span>
</span><span id="check_BurstResponses-488"><a href="#check_BurstResponses-488"><span class="linenos">488</span></a>    
</span><span id="check_BurstResponses-489"><a href="#check_BurstResponses-489"><span class="linenos">489</span></a>    <span class="c1"># Unflagging when using multiple burst flags (to avoid double counting)</span>
</span><span id="check_BurstResponses-490"><a href="#check_BurstResponses-490"><span class="linenos">490</span></a>    <span class="n">nearby_df</span><span class="p">[</span><span class="s1">&#39;unflag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="check_BurstResponses-491"><a href="#check_BurstResponses-491"><span class="linenos">491</span></a>    <span class="k">if</span> <span class="n">unflag_start_time_difference</span> <span class="ow">and</span> <span class="n">unflag_duration_difference</span><span class="p">:</span>
</span><span id="check_BurstResponses-492"><a href="#check_BurstResponses-492"><span class="linenos">492</span></a>        <span class="n">nearby_df</span><span class="p">[</span><span class="s1">&#39;unflag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nearby_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_num_responses</span><span class="p">,</span> 
</span><span id="check_BurstResponses-493"><a href="#check_BurstResponses-493"><span class="linenos">493</span></a>                                       <span class="n">max_start</span><span class="o">=</span><span class="n">unflag_start_time_difference</span><span class="p">,</span> 
</span><span id="check_BurstResponses-494"><a href="#check_BurstResponses-494"><span class="linenos">494</span></a>                                       <span class="n">max_duration</span><span class="o">=</span><span class="n">unflag_duration_difference</span><span class="p">,</span>
</span><span id="check_BurstResponses-495"><a href="#check_BurstResponses-495"><span class="linenos">495</span></a>                                       <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
</span><span id="check_BurstResponses-496"><a href="#check_BurstResponses-496"><span class="linenos">496</span></a>    
</span><span id="check_BurstResponses-497"><a href="#check_BurstResponses-497"><span class="linenos">497</span></a>    <span class="c1"># Add a column with number of similar responses</span>
</span><span id="check_BurstResponses-498"><a href="#check_BurstResponses-498"><span class="linenos">498</span></a>    <span class="n">num_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;F</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">_count&quot;</span>
</span><span id="check_BurstResponses-499"><a href="#check_BurstResponses-499"><span class="linenos">499</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">num_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nearby_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_num_responses</span><span class="p">,</span> 
</span><span id="check_BurstResponses-500"><a href="#check_BurstResponses-500"><span class="linenos">500</span></a>                                  <span class="n">max_start</span><span class="o">=</span><span class="n">max_start_time_difference</span><span class="p">,</span> 
</span><span id="check_BurstResponses-501"><a href="#check_BurstResponses-501"><span class="linenos">501</span></a>                                  <span class="n">max_duration</span><span class="o">=</span><span class="n">max_duration_difference</span><span class="p">,</span>
</span><span id="check_BurstResponses-502"><a href="#check_BurstResponses-502"><span class="linenos">502</span></a>                                  <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="check_BurstResponses-503"><a href="#check_BurstResponses-503"><span class="linenos">503</span></a>                  <span class="o">-</span> <span class="n">nearby_df</span><span class="p">[</span><span class="s1">&#39;unflag&#39;</span><span class="p">])</span>
</span><span id="check_BurstResponses-504"><a href="#check_BurstResponses-504"><span class="linenos">504</span></a>    
</span><span id="check_BurstResponses-505"><a href="#check_BurstResponses-505"><span class="linenos">505</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">num_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="check_BurstResponses-506"><a href="#check_BurstResponses-506"><span class="linenos">506</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a flag column to the dataframe for burst of responses with similar start times and durations.
Adds an additional column with number of burst responses <code>NumBurstResponses</code>.
This method implements a lower bound and an upper bound for start time and duration differences to allow for graded flagging. </p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with relevant columns.</li>
<li><strong>flag_name (str) :</strong>  Flag name.</li>
<li><strong>column_start_time (str) :</strong>  Column name for survey start date and time.</li>
<li><strong>column_duration (str) :</strong>  Column name for survey duration.</li>
<li><strong>max_start_time_difference (int) :</strong>  Maximum absolute difference between start times.</li>
<li><strong>max_duration_difference (int) :</strong>  Maximum absolute difference between survey durations.</li>
<li><strong>unflag_start_time_difference (int) :</strong>  Maximum start time difference for not flagging the responses.</li>
<li><strong>unflag_duration_difference (int) :</strong>  Maximum duration difference for not flagging the responses.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with flag.</p>
</blockquote>
</div>


                </section>
                <section id="check_DuplicatedText">
                            <input id="check_DuplicatedText-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-summary_wrapper">@summary_wrapper</div>

        <span class="def">def</span>
        <span class="name">check_DuplicatedText</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">flag_name</span>,</span><span class="param">	<span class="n">list_of_columns</span>,</span><span class="param">	<span class="n">min_length</span>,</span><span class="param">	<span class="n">max_length</span>,</span><span class="param">	<span class="n">search_strategy</span><span class="o">=</span><span class="s1">&#39;column&#39;</span>,</span><span class="param">	<span class="n">create_column_flag</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_DuplicatedText-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_DuplicatedText"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_DuplicatedText-508"><a href="#check_DuplicatedText-508"><span class="linenos">508</span></a><span class="nd">@summary_wrapper</span>
</span><span id="check_DuplicatedText-509"><a href="#check_DuplicatedText-509"><span class="linenos">509</span></a><span class="k">def</span><span class="w"> </span><span class="nf">check_DuplicatedText</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">list_of_columns</span><span class="p">,</span> <span class="n">min_length</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> 
</span><span id="check_DuplicatedText-510"><a href="#check_DuplicatedText-510"><span class="linenos">510</span></a>                                 <span class="n">search_strategy</span><span class="o">=</span><span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="n">create_column_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="check_DuplicatedText-511"><a href="#check_DuplicatedText-511"><span class="linenos">511</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="check_DuplicatedText-512"><a href="#check_DuplicatedText-512"><span class="linenos">512</span></a><span class="sd">    Adds a flag column to the dataframe for very short survey duration.</span>
</span><span id="check_DuplicatedText-513"><a href="#check_DuplicatedText-513"><span class="linenos">513</span></a><span class="sd">        </span>
</span><span id="check_DuplicatedText-514"><a href="#check_DuplicatedText-514"><span class="linenos">514</span></a><span class="sd">    Parameters:</span>
</span><span id="check_DuplicatedText-515"><a href="#check_DuplicatedText-515"><span class="linenos">515</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with relevant columns.</span>
</span><span id="check_DuplicatedText-516"><a href="#check_DuplicatedText-516"><span class="linenos">516</span></a><span class="sd">        flag_name (str) : Flag name.</span>
</span><span id="check_DuplicatedText-517"><a href="#check_DuplicatedText-517"><span class="linenos">517</span></a><span class="sd">        list_of_columns (List[str]) : List of column names for text responses.</span>
</span><span id="check_DuplicatedText-518"><a href="#check_DuplicatedText-518"><span class="linenos">518</span></a><span class="sd">        min_length (int) : Minimum string length of text responses.</span>
</span><span id="check_DuplicatedText-519"><a href="#check_DuplicatedText-519"><span class="linenos">519</span></a><span class="sd">        max_length (int) : Maximum string length of text responses.</span>
</span><span id="check_DuplicatedText-520"><a href="#check_DuplicatedText-520"><span class="linenos">520</span></a><span class="sd">        search_strategy (str) : Search strategy to mark duplicates. Defaults to &#39;column&#39;.</span>
</span><span id="check_DuplicatedText-521"><a href="#check_DuplicatedText-521"><span class="linenos">521</span></a><span class="sd">            &#39;column&#39; looks for duplicates within each text column and flags if any of the columns contains a duplicate. </span>
</span><span id="check_DuplicatedText-522"><a href="#check_DuplicatedText-522"><span class="linenos">522</span></a><span class="sd">                This strategy creates flags for individual columns as well.</span>
</span><span id="check_DuplicatedText-523"><a href="#check_DuplicatedText-523"><span class="linenos">523</span></a><span class="sd">            &#39;all&#39; looks for duplicates across all text columns.</span>
</span><span id="check_DuplicatedText-524"><a href="#check_DuplicatedText-524"><span class="linenos">524</span></a><span class="sd">        create_column_flag (boolean): Bollean to add column-wise flag. Defaults to False.</span>
</span><span id="check_DuplicatedText-525"><a href="#check_DuplicatedText-525"><span class="linenos">525</span></a><span class="sd">        </span>
</span><span id="check_DuplicatedText-526"><a href="#check_DuplicatedText-526"><span class="linenos">526</span></a><span class="sd">    Returns:</span>
</span><span id="check_DuplicatedText-527"><a href="#check_DuplicatedText-527"><span class="linenos">527</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag.</span>
</span><span id="check_DuplicatedText-528"><a href="#check_DuplicatedText-528"><span class="linenos">528</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_DuplicatedText-529"><a href="#check_DuplicatedText-529"><span class="linenos">529</span></a>    <span class="c1"># Create individual flag for columns with duplicates</span>
</span><span id="check_DuplicatedText-530"><a href="#check_DuplicatedText-530"><span class="linenos">530</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="check_DuplicatedText-531"><a href="#check_DuplicatedText-531"><span class="linenos">531</span></a>    
</span><span id="check_DuplicatedText-532"><a href="#check_DuplicatedText-532"><span class="linenos">532</span></a>    <span class="c1"># Convert string object (if any) to list</span>
</span><span id="check_DuplicatedText-533"><a href="#check_DuplicatedText-533"><span class="linenos">533</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_of_columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="check_DuplicatedText-534"><a href="#check_DuplicatedText-534"><span class="linenos">534</span></a>        <span class="n">list_of_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_of_columns</span><span class="p">]</span>
</span><span id="check_DuplicatedText-535"><a href="#check_DuplicatedText-535"><span class="linenos">535</span></a>    
</span><span id="check_DuplicatedText-536"><a href="#check_DuplicatedText-536"><span class="linenos">536</span></a>    <span class="c1">## Search strategies</span>
</span><span id="check_DuplicatedText-537"><a href="#check_DuplicatedText-537"><span class="linenos">537</span></a>    <span class="k">if</span> <span class="n">search_strategy</span> <span class="o">==</span> <span class="s1">&#39;column&#39;</span><span class="p">:</span>
</span><span id="check_DuplicatedText-538"><a href="#check_DuplicatedText-538"><span class="linenos">538</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">list_of_columns</span><span class="p">:</span>
</span><span id="check_DuplicatedText-539"><a href="#check_DuplicatedText-539"><span class="linenos">539</span></a>            <span class="c1"># Strips and lowercase all text responses</span>
</span><span id="check_DuplicatedText-540"><a href="#check_DuplicatedText-540"><span class="linenos">540</span></a>            <span class="n">lower_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="check_DuplicatedText-541"><a href="#check_DuplicatedText-541"><span class="linenos">541</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="check_DuplicatedText-542"><a href="#check_DuplicatedText-542"><span class="linenos">542</span></a>                <span class="p">(</span><span class="n">lower_df</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_length</span><span class="p">)</span> 
</span><span id="check_DuplicatedText-543"><a href="#check_DuplicatedText-543"><span class="linenos">543</span></a>                <span class="o">&amp;</span> <span class="p">(</span><span class="n">lower_df</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">)</span>
</span><span id="check_DuplicatedText-544"><a href="#check_DuplicatedText-544"><span class="linenos">544</span></a>                <span class="o">&amp;</span> <span class="p">(</span><span class="n">lower_df</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
</span><span id="check_DuplicatedText-545"><a href="#check_DuplicatedText-545"><span class="linenos">545</span></a>                <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">lower_df</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
</span><span id="check_DuplicatedText-546"><a href="#check_DuplicatedText-546"><span class="linenos">546</span></a>            <span class="p">)</span>
</span><span id="check_DuplicatedText-547"><a href="#check_DuplicatedText-547"><span class="linenos">547</span></a>            <span class="c1"># Create a flag for each individual column</span>
</span><span id="check_DuplicatedText-548"><a href="#check_DuplicatedText-548"><span class="linenos">548</span></a>            <span class="k">if</span> <span class="n">create_column_flag</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="check_DuplicatedText-549"><a href="#check_DuplicatedText-549"><span class="linenos">549</span></a>                <span class="n">flag_name_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="check_DuplicatedText-550"><a href="#check_DuplicatedText-550"><span class="linenos">550</span></a>                <span class="n">df</span><span class="p">[</span><span class="n">flag_name_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> 
</span><span id="check_DuplicatedText-551"><a href="#check_DuplicatedText-551"><span class="linenos">551</span></a>    
</span><span id="check_DuplicatedText-552"><a href="#check_DuplicatedText-552"><span class="linenos">552</span></a>            <span class="c1"># Combined flag across all columns. Marks if any column value is duplicated</span>
</span><span id="check_DuplicatedText-553"><a href="#check_DuplicatedText-553"><span class="linenos">553</span></a>            <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mask</span> <span class="c1"># Use |= for any column flagged and &amp;= for all column flagged</span>
</span><span id="check_DuplicatedText-554"><a href="#check_DuplicatedText-554"><span class="linenos">554</span></a>        
</span><span id="check_DuplicatedText-555"><a href="#check_DuplicatedText-555"><span class="linenos">555</span></a>    <span class="k">elif</span> <span class="n">search_strategy</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
</span><span id="check_DuplicatedText-556"><a href="#check_DuplicatedText-556"><span class="linenos">556</span></a>        <span class="c1"># Flatten the dataFrame while preserving the original index</span>
</span><span id="check_DuplicatedText-557"><a href="#check_DuplicatedText-557"><span class="linenos">557</span></a>        <span class="n">flattened_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">list_of_columns</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="check_DuplicatedText-558"><a href="#check_DuplicatedText-558"><span class="linenos">558</span></a>        <span class="c1"># &#39;level_0&#39; is the original index, and 0 are the values</span>
</span><span id="check_DuplicatedText-559"><a href="#check_DuplicatedText-559"><span class="linenos">559</span></a>        <span class="n">flattened_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;original_index&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>
</span><span id="check_DuplicatedText-560"><a href="#check_DuplicatedText-560"><span class="linenos">560</span></a>        <span class="c1"># Strips and lowercase all text responses</span>
</span><span id="check_DuplicatedText-561"><a href="#check_DuplicatedText-561"><span class="linenos">561</span></a>        <span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="check_DuplicatedText-562"><a href="#check_DuplicatedText-562"><span class="linenos">562</span></a>        
</span><span id="check_DuplicatedText-563"><a href="#check_DuplicatedText-563"><span class="linenos">563</span></a>        <span class="c1"># Check for duplicates (count number of occurences within the entire dataframe)</span>
</span><span id="check_DuplicatedText-564"><a href="#check_DuplicatedText-564"><span class="linenos">564</span></a>        <span class="n">duplicates_all</span> <span class="o">=</span> <span class="n">flattened_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;value&#39;</span><span class="p">])[</span><span class="s1">&#39;original_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span>
</span><span id="check_DuplicatedText-565"><a href="#check_DuplicatedText-565"><span class="linenos">565</span></a>        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">((</span><span class="n">duplicates_all</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># number of occurences &gt; 1</span>
</span><span id="check_DuplicatedText-566"><a href="#check_DuplicatedText-566"><span class="linenos">566</span></a>                      <span class="o">&amp;</span> <span class="p">(</span><span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_length</span><span class="p">)</span>  <span class="c1"># string length check</span>
</span><span id="check_DuplicatedText-567"><a href="#check_DuplicatedText-567"><span class="linenos">567</span></a>                      <span class="o">&amp;</span> <span class="p">(</span><span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">))</span>
</span><span id="check_DuplicatedText-568"><a href="#check_DuplicatedText-568"><span class="linenos">568</span></a>        <span class="c1"># Map these duplicate flag_names back to the original DataFrame&#39;s index</span>
</span><span id="check_DuplicatedText-569"><a href="#check_DuplicatedText-569"><span class="linenos">569</span></a>        <span class="n">df</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">flattened_df</span><span class="p">[</span><span class="s1">&#39;original_index&#39;</span><span class="p">][</span><span class="n">duplicates</span><span class="p">])</span>
</span><span id="check_DuplicatedText-570"><a href="#check_DuplicatedText-570"><span class="linenos">570</span></a>
</span><span id="check_DuplicatedText-571"><a href="#check_DuplicatedText-571"><span class="linenos">571</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="check_DuplicatedText-572"><a href="#check_DuplicatedText-572"><span class="linenos">572</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The search strategy should be either &#39;column&#39; or &#39;all&#39;. Instead, the strategy provided is </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">search_strategy</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="check_DuplicatedText-573"><a href="#check_DuplicatedText-573"><span class="linenos">573</span></a>        
</span><span id="check_DuplicatedText-574"><a href="#check_DuplicatedText-574"><span class="linenos">574</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Adds a flag column to the dataframe for very short survey duration.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with relevant columns.</li>
<li><strong>flag_name (str) :</strong>  Flag name.</li>
<li><strong>list_of_columns (List[str]) :</strong>  List of column names for text responses.</li>
<li><strong>min_length (int) :</strong>  Minimum string length of text responses.</li>
<li><strong>max_length (int) :</strong>  Maximum string length of text responses.</li>
<li><strong>search_strategy (str) :</strong>  Search strategy to mark duplicates. Defaults to 'column'.
'column' looks for duplicates within each text column and flags if any of the columns contains a duplicate. 
    This strategy creates flags for individual columns as well.
'all' looks for duplicates across all text columns.</li>
<li><strong>create_column_flag (boolean):</strong>  Bollean to add column-wise flag. Defaults to False.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with flag.</p>
</blockquote>
</div>


                </section>
                <section id="decode_special_floats">
                            <input id="decode_special_floats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">decode_special_floats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">dct</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="decode_special_floats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#decode_special_floats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="decode_special_floats-581"><a href="#decode_special_floats-581"><span class="linenos">581</span></a><span class="k">def</span><span class="w"> </span><span class="nf">decode_special_floats</span><span class="p">(</span><span class="n">dct</span><span class="p">):</span>
</span><span id="decode_special_floats-582"><a href="#decode_special_floats-582"><span class="linenos">582</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="decode_special_floats-583"><a href="#decode_special_floats-583"><span class="linenos">583</span></a><span class="sd">    Converts the special values (e.g., infinity) in the JSON object in the parameters file to Python numeric values. </span>
</span><span id="decode_special_floats-584"><a href="#decode_special_floats-584"><span class="linenos">584</span></a><span class="sd">    The parameters file accepts the following values:</span>
</span><span id="decode_special_floats-585"><a href="#decode_special_floats-585"><span class="linenos">585</span></a><span class="sd">        Positive infinity as &quot;infinity&quot; or &quot;inf&quot;.</span>
</span><span id="decode_special_floats-586"><a href="#decode_special_floats-586"><span class="linenos">586</span></a><span class="sd">        Negative infinity as &quot;-infinity&quot; or &quot;-inf&quot;.</span>
</span><span id="decode_special_floats-587"><a href="#decode_special_floats-587"><span class="linenos">587</span></a><span class="sd">        Empty or missing values as &quot;nan&quot;, &quot;nil&quot;, or &quot;none&quot;.</span>
</span><span id="decode_special_floats-588"><a href="#decode_special_floats-588"><span class="linenos">588</span></a><span class="sd">        True as &quot;true&quot;.</span>
</span><span id="decode_special_floats-589"><a href="#decode_special_floats-589"><span class="linenos">589</span></a><span class="sd">        False as &quot;false&quot;.</span>
</span><span id="decode_special_floats-590"><a href="#decode_special_floats-590"><span class="linenos">590</span></a>
</span><span id="decode_special_floats-591"><a href="#decode_special_floats-591"><span class="linenos">591</span></a><span class="sd">    Parameters:</span>
</span><span id="decode_special_floats-592"><a href="#decode_special_floats-592"><span class="linenos">592</span></a><span class="sd">        dct (dict) : Dictionary with JSON values.</span>
</span><span id="decode_special_floats-593"><a href="#decode_special_floats-593"><span class="linenos">593</span></a><span class="sd">        </span>
</span><span id="decode_special_floats-594"><a href="#decode_special_floats-594"><span class="linenos">594</span></a><span class="sd">    Returns:</span>
</span><span id="decode_special_floats-595"><a href="#decode_special_floats-595"><span class="linenos">595</span></a><span class="sd">        dct (dict) : Dictionary with corresponding Python values.</span>
</span><span id="decode_special_floats-596"><a href="#decode_special_floats-596"><span class="linenos">596</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="decode_special_floats-597"><a href="#decode_special_floats-597"><span class="linenos">597</span></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="decode_special_floats-598"><a href="#decode_special_floats-598"><span class="linenos">598</span></a>        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
</span><span id="decode_special_floats-599"><a href="#decode_special_floats-599"><span class="linenos">599</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;infinity&quot;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;inf&quot;</span><span class="p">:</span>
</span><span id="decode_special_floats-600"><a href="#decode_special_floats-600"><span class="linenos">600</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="decode_special_floats-601"><a href="#decode_special_floats-601"><span class="linenos">601</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;-infinity&quot;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;-inf&quot;</span><span class="p">:</span>
</span><span id="decode_special_floats-602"><a href="#decode_special_floats-602"><span class="linenos">602</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="decode_special_floats-603"><a href="#decode_special_floats-603"><span class="linenos">603</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;nil&quot;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
</span><span id="decode_special_floats-604"><a href="#decode_special_floats-604"><span class="linenos">604</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="decode_special_floats-605"><a href="#decode_special_floats-605"><span class="linenos">605</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
</span><span id="decode_special_floats-606"><a href="#decode_special_floats-606"><span class="linenos">606</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="decode_special_floats-607"><a href="#decode_special_floats-607"><span class="linenos">607</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
</span><span id="decode_special_floats-608"><a href="#decode_special_floats-608"><span class="linenos">608</span></a>            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="decode_special_floats-609"><a href="#decode_special_floats-609"><span class="linenos">609</span></a>    <span class="k">return</span> <span class="n">dct</span>
</span></pre></div>


            <div class="docstring"><p>Converts the special values (e.g., infinity) in the JSON object in the parameters file to Python numeric values. </p>

<h6 id="the-parameters-file-accepts-the-following-values">The parameters file accepts the following values:</h6>

<blockquote>
  <p>Positive infinity as "infinity" or "inf".
  Negative infinity as "-infinity" or "-inf".
  Empty or missing values as "nan", "nil", or "none".
  True as "true".
  False as "false".</p>
</blockquote>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>dct (dict) :</strong>  Dictionary with JSON values.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>dct (dict) : Dictionary with corresponding Python values.</p>
</blockquote>
</div>


                </section>
                <section id="flag_responses">
                            <input id="flag_responses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">flag_responses</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">params_sheet</span>, </span><span class="param"><span class="n">add_string</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="flag_responses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#flag_responses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="flag_responses-611"><a href="#flag_responses-611"><span class="linenos">611</span></a><span class="k">def</span><span class="w"> </span><span class="nf">flag_responses</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params_sheet</span><span class="p">,</span> <span class="n">add_string</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="flag_responses-612"><a href="#flag_responses-612"><span class="linenos">612</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="flag_responses-613"><a href="#flag_responses-613"><span class="linenos">613</span></a><span class="sd">    Applies the flags provided by the user. </span>
</span><span id="flag_responses-614"><a href="#flag_responses-614"><span class="linenos">614</span></a>
</span><span id="flag_responses-615"><a href="#flag_responses-615"><span class="linenos">615</span></a><span class="sd">    Parameters:</span>
</span><span id="flag_responses-616"><a href="#flag_responses-616"><span class="linenos">616</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with survey data. </span>
</span><span id="flag_responses-617"><a href="#flag_responses-617"><span class="linenos">617</span></a><span class="sd">        params_sheet (str) : Excel sheet name in the parameters file with flag information (&#39;flags&#39;)</span>
</span><span id="flag_responses-618"><a href="#flag_responses-618"><span class="linenos">618</span></a><span class="sd">            Must contain columns &#39;flag_name&#39;, &#39;method_name&#39;, &#39;flag_group&#39;, &#39;use_flag&#39;, &#39;parameters&#39;.</span>
</span><span id="flag_responses-619"><a href="#flag_responses-619"><span class="linenos">619</span></a><span class="sd">        add_string (boolean) : Whether to add string-formatted columns for activated flags and flag groups. Defaults to True.</span>
</span><span id="flag_responses-620"><a href="#flag_responses-620"><span class="linenos">620</span></a>
</span><span id="flag_responses-621"><a href="#flag_responses-621"><span class="linenos">621</span></a><span class="sd">    Returns:</span>
</span><span id="flag_responses-622"><a href="#flag_responses-622"><span class="linenos">622</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with added flag and flag group columns.</span>
</span><span id="flag_responses-623"><a href="#flag_responses-623"><span class="linenos">623</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="flag_responses-624"><a href="#flag_responses-624"><span class="linenos">624</span></a>    <span class="c1">## Reading flag parameters</span>
</span><span id="flag_responses-625"><a href="#flag_responses-625"><span class="linenos">625</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">params_sheet</span><span class="p">)</span>
</span><span id="flag_responses-626"><a href="#flag_responses-626"><span class="linenos">626</span></a>    <span class="c1"># Verify necessary columns</span>
</span><span id="flag_responses-627"><a href="#flag_responses-627"><span class="linenos">627</span></a>    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">,</span> <span class="s1">&#39;method_name&#39;</span><span class="p">,</span> <span class="s1">&#39;flag_group&#39;</span><span class="p">,</span> <span class="s1">&#39;use_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
</span><span id="flag_responses-628"><a href="#flag_responses-628"><span class="linenos">628</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="flag_responses-629"><a href="#flag_responses-629"><span class="linenos">629</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="flag_responses-630"><a href="#flag_responses-630"><span class="linenos">630</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns in sheet &#39;</span><span class="si">{</span><span class="n">params_sheet</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="flag_responses-631"><a href="#flag_responses-631"><span class="linenos">631</span></a>    <span class="c1"># Drop inactive flags</span>
</span><span id="flag_responses-632"><a href="#flag_responses-632"><span class="linenos">632</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;use_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> 
</span><span id="flag_responses-633"><a href="#flag_responses-633"><span class="linenos">633</span></a>
</span><span id="flag_responses-634"><a href="#flag_responses-634"><span class="linenos">634</span></a>    <span class="c1">## Apply individual flags</span>
</span><span id="flag_responses-635"><a href="#flag_responses-635"><span class="linenos">635</span></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="flag_responses-636"><a href="#flag_responses-636"><span class="linenos">636</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">***** Executing: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> *****&quot;</span><span class="p">)</span>
</span><span id="flag_responses-637"><a href="#flag_responses-637"><span class="linenos">637</span></a>        <span class="c1"># Read `parameters` columns in JSON format while decoding special floats</span>
</span><span id="flag_responses-638"><a href="#flag_responses-638"><span class="linenos">638</span></a>        <span class="n">flag_parameters</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">],</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">decode_special_floats</span><span class="p">)</span>
</span><span id="flag_responses-639"><a href="#flag_responses-639"><span class="linenos">639</span></a>
</span><span id="flag_responses-640"><a href="#flag_responses-640"><span class="linenos">640</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
</span><span id="flag_responses-641"><a href="#flag_responses-641"><span class="linenos">641</span></a>            <span class="nb">eval</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;method_name&#39;</span><span class="p">]),</span>       <span class="c1"># Method to implement `method_name`</span>
</span><span id="flag_responses-642"><a href="#flag_responses-642"><span class="linenos">642</span></a>            <span class="n">flag_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">],</span>     <span class="c1"># Flag name `flag_name`</span>
</span><span id="flag_responses-643"><a href="#flag_responses-643"><span class="linenos">643</span></a>            <span class="o">**</span><span class="n">flag_parameters</span>               <span class="c1"># Flag parameters `parameters`</span>
</span><span id="flag_responses-644"><a href="#flag_responses-644"><span class="linenos">644</span></a>        <span class="p">)</span>
</span><span id="flag_responses-645"><a href="#flag_responses-645"><span class="linenos">645</span></a>      
</span><span id="flag_responses-646"><a href="#flag_responses-646"><span class="linenos">646</span></a>    <span class="c1">## Add flag count by flag group</span>
</span><span id="flag_responses-647"><a href="#flag_responses-647"><span class="linenos">647</span></a>    <span class="n">dict_flags</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;flag_group&#39;</span><span class="p">)[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>    <span class="c1"># List of flags for each flag group</span>
</span><span id="flag_responses-648"><a href="#flag_responses-648"><span class="linenos">648</span></a>    <span class="k">for</span> <span class="n">flag_group</span><span class="p">,</span> <span class="n">list_flags</span> <span class="ow">in</span> <span class="n">dict_flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="flag_responses-649"><a href="#flag_responses-649"><span class="linenos">649</span></a>        <span class="n">df</span><span class="p">[</span><span class="n">flag_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">list_flags</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                     <span class="c1"># Each flag in list_flags is a Boolean column </span>
</span><span id="flag_responses-650"><a href="#flag_responses-650"><span class="linenos">650</span></a>
</span><span id="flag_responses-651"><a href="#flag_responses-651"><span class="linenos">651</span></a>    <span class="c1">## Add string-formatted columns for activated flags and flag groups</span>
</span><span id="flag_responses-652"><a href="#flag_responses-652"><span class="linenos">652</span></a>    <span class="k">if</span> <span class="n">add_string</span><span class="p">:</span>
</span><span id="flag_responses-653"><a href="#flag_responses-653"><span class="linenos">653</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ActiveFlags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="flag_responses-654"><a href="#flag_responses-654"><span class="linenos">654</span></a>            <span class="n">df</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>                             <span class="c1"># Selecting relevant columns </span>
</span><span id="flag_responses-655"><a href="#flag_responses-655"><span class="linenos">655</span></a>            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>                                                       <span class="c1"># Converts 0 to False</span>
</span><span id="flag_responses-656"><a href="#flag_responses-656"><span class="linenos">656</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># Join the column labels with True</span>
</span><span id="flag_responses-657"><a href="#flag_responses-657"><span class="linenos">657</span></a>        <span class="p">)</span>
</span><span id="flag_responses-658"><a href="#flag_responses-658"><span class="linenos">658</span></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ActiveFlagGroups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="flag_responses-659"><a href="#flag_responses-659"><span class="linenos">659</span></a>            <span class="n">df</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>                          <span class="c1"># Selecting relevant columns </span>
</span><span id="flag_responses-660"><a href="#flag_responses-660"><span class="linenos">660</span></a>            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>                                                       <span class="c1"># Converts 0 to False</span>
</span><span id="flag_responses-661"><a href="#flag_responses-661"><span class="linenos">661</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># Join the column labels with True</span>
</span><span id="flag_responses-662"><a href="#flag_responses-662"><span class="linenos">662</span></a>        <span class="p">)</span>
</span><span id="flag_responses-663"><a href="#flag_responses-663"><span class="linenos">663</span></a>
</span><span id="flag_responses-664"><a href="#flag_responses-664"><span class="linenos">664</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Applies the flags provided by the user. </p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with survey data. </li>
<li><strong>params_sheet (str) :</strong>  Excel sheet name in the parameters file with flag information ('flags')
Must contain columns 'flag_name', 'method_name', 'flag_group', 'use_flag', 'parameters'.</li>
<li><strong>add_string (boolean) :</strong>  Whether to add string-formatted columns for activated flags and flag groups. Defaults to True.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>df (pd.DataFrame) : Dataframe with added flag and flag group columns.</p>
</blockquote>
</div>


                </section>
                <section id="classify_responses">
                            <input id="classify_responses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">classify_responses</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">params_sheet</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="classify_responses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#classify_responses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="classify_responses-666"><a href="#classify_responses-666"><span class="linenos">666</span></a><span class="k">def</span><span class="w"> </span><span class="nf">classify_responses</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params_sheet</span><span class="p">):</span>
</span><span id="classify_responses-667"><a href="#classify_responses-667"><span class="linenos">667</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="classify_responses-668"><a href="#classify_responses-668"><span class="linenos">668</span></a><span class="sd">    Applies fraud classification rules loaded from an Excel file. Rules must be listed in the descending order of importance.</span>
</span><span id="classify_responses-669"><a href="#classify_responses-669"><span class="linenos">669</span></a>
</span><span id="classify_responses-670"><a href="#classify_responses-670"><span class="linenos">670</span></a><span class="sd">    Parameters:</span>
</span><span id="classify_responses-671"><a href="#classify_responses-671"><span class="linenos">671</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with flag groups and relevant indicators.</span>
</span><span id="classify_responses-672"><a href="#classify_responses-672"><span class="linenos">672</span></a><span class="sd">        params_sheet (str) : Excel sheet name in parametrs file with rule logic (&#39;initial_classification_rules&#39;).</span>
</span><span id="classify_responses-673"><a href="#classify_responses-673"><span class="linenos">673</span></a><span class="sd">            Must contain columns &#39;rule_num&#39;, &#39;condition_expr&#39;, &#39;classification&#39;, &#39;use_rule&#39;.</span>
</span><span id="classify_responses-674"><a href="#classify_responses-674"><span class="linenos">674</span></a>
</span><span id="classify_responses-675"><a href="#classify_responses-675"><span class="linenos">675</span></a><span class="sd">    Returns:</span>
</span><span id="classify_responses-676"><a href="#classify_responses-676"><span class="linenos">676</span></a><span class="sd">        classified_rules (pd.DataFrame) : Dataframe with flag `classification` and `rule_num` columns.</span>
</span><span id="classify_responses-677"><a href="#classify_responses-677"><span class="linenos">677</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="classify_responses-678"><a href="#classify_responses-678"><span class="linenos">678</span></a>    <span class="c1">## Reading classification rule parameters</span>
</span><span id="classify_responses-679"><a href="#classify_responses-679"><span class="linenos">679</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">params_sheet</span><span class="p">)</span>
</span><span id="classify_responses-680"><a href="#classify_responses-680"><span class="linenos">680</span></a>    <span class="c1"># Verify necessary columns</span>
</span><span id="classify_responses-681"><a href="#classify_responses-681"><span class="linenos">681</span></a>    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rule_num&#39;</span><span class="p">,</span> <span class="s1">&#39;condition_expr&#39;</span><span class="p">,</span> <span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="s1">&#39;use_rule&#39;</span><span class="p">]</span>
</span><span id="classify_responses-682"><a href="#classify_responses-682"><span class="linenos">682</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="classify_responses-683"><a href="#classify_responses-683"><span class="linenos">683</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="classify_responses-684"><a href="#classify_responses-684"><span class="linenos">684</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns in sheet &#39;</span><span class="si">{</span><span class="n">params_sheet</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="classify_responses-685"><a href="#classify_responses-685"><span class="linenos">685</span></a>    <span class="c1"># Drop inactive flags</span>
</span><span id="classify_responses-686"><a href="#classify_responses-686"><span class="linenos">686</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;use_rule&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> 
</span><span id="classify_responses-687"><a href="#classify_responses-687"><span class="linenos">687</span></a>
</span><span id="classify_responses-688"><a href="#classify_responses-688"><span class="linenos">688</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_rules</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
</span><span id="classify_responses-689"><a href="#classify_responses-689"><span class="linenos">689</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="classify_responses-690"><a href="#classify_responses-690"><span class="linenos">690</span></a><span class="sd">        Sequentially applies classification rules from the parameters to each response.</span>
</span><span id="classify_responses-691"><a href="#classify_responses-691"><span class="linenos">691</span></a><span class="sd">        Stops exceuting further rules if a rules requirements are met. </span>
</span><span id="classify_responses-692"><a href="#classify_responses-692"><span class="linenos">692</span></a><span class="sd">        Raises an error if any rule cannot be evaluated.</span>
</span><span id="classify_responses-693"><a href="#classify_responses-693"><span class="linenos">693</span></a>
</span><span id="classify_responses-694"><a href="#classify_responses-694"><span class="linenos">694</span></a><span class="sd">        Parameters:</span>
</span><span id="classify_responses-695"><a href="#classify_responses-695"><span class="linenos">695</span></a><span class="sd">            row (pd.Series) : A single row of the dataframe with required columns. </span>
</span><span id="classify_responses-696"><a href="#classify_responses-696"><span class="linenos">696</span></a>
</span><span id="classify_responses-697"><a href="#classify_responses-697"><span class="linenos">697</span></a><span class="sd">        Returns:</span>
</span><span id="classify_responses-698"><a href="#classify_responses-698"><span class="linenos">698</span></a><span class="sd">            Tuple : A tuple with &#39;classification&#39; and &#39;rule_num&#39;.  </span>
</span><span id="classify_responses-699"><a href="#classify_responses-699"><span class="linenos">699</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="classify_responses-700"><a href="#classify_responses-700"><span class="linenos">700</span></a>        <span class="n">local_dict</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="classify_responses-701"><a href="#classify_responses-701"><span class="linenos">701</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="classify_responses-702"><a href="#classify_responses-702"><span class="linenos">702</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="classify_responses-703"><a href="#classify_responses-703"><span class="linenos">703</span></a>                <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;condition_expr&#39;</span><span class="p">],</span> <span class="p">{},</span> <span class="n">local_dict</span><span class="p">):</span>
</span><span id="classify_responses-704"><a href="#classify_responses-704"><span class="linenos">704</span></a>                    <span class="k">return</span> <span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">],</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;rule_num&#39;</span><span class="p">])</span>
</span><span id="classify_responses-705"><a href="#classify_responses-705"><span class="linenos">705</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="classify_responses-706"><a href="#classify_responses-706"><span class="linenos">706</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in </span><span class="si">{</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;rule_num&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> using the expression: </span><span class="si">{</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;condition_expr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="classify_responses-707"><a href="#classify_responses-707"><span class="linenos">707</span></a>            
</span><span id="classify_responses-708"><a href="#classify_responses-708"><span class="linenos">708</span></a>        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;VALID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> 
</span><span id="classify_responses-709"><a href="#classify_responses-709"><span class="linenos">709</span></a>
</span><span id="classify_responses-710"><a href="#classify_responses-710"><span class="linenos">710</span></a>    <span class="n">classified_rules</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">evaluate_rules</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span> <span class="c1"># Dataframe with two columns</span>
</span><span id="classify_responses-711"><a href="#classify_responses-711"><span class="linenos">711</span></a>
</span><span id="classify_responses-712"><a href="#classify_responses-712"><span class="linenos">712</span></a>    <span class="k">return</span> <span class="n">classified_rules</span>  
</span></pre></div>


            <div class="docstring"><p>Applies fraud classification rules loaded from an Excel file. Rules must be listed in the descending order of importance.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with flag groups and relevant indicators.</li>
<li><strong>params_sheet (str) :</strong>  Excel sheet name in parametrs file with rule logic ('initial_classification_rules').
Must contain columns 'rule_num', 'condition_expr', 'classification', 'use_rule'.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>classified_rules (pd.DataFrame) : Dataframe with flag <code>classification</code> and <code>rule_num</code> columns.</p>
</blockquote>
</div>


                </section>
                <section id="print_flag_counts">
                            <input id="print_flag_counts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_flag_counts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">params_sheet</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="print_flag_counts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#print_flag_counts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="print_flag_counts-718"><a href="#print_flag_counts-718"><span class="linenos">718</span></a><span class="k">def</span><span class="w"> </span><span class="nf">print_flag_counts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params_sheet</span><span class="p">):</span>
</span><span id="print_flag_counts-719"><a href="#print_flag_counts-719"><span class="linenos">719</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="print_flag_counts-720"><a href="#print_flag_counts-720"><span class="linenos">720</span></a><span class="sd">    Prints out simple counts of flags and flag groups. </span>
</span><span id="print_flag_counts-721"><a href="#print_flag_counts-721"><span class="linenos">721</span></a>
</span><span id="print_flag_counts-722"><a href="#print_flag_counts-722"><span class="linenos">722</span></a><span class="sd">    Parameters:</span>
</span><span id="print_flag_counts-723"><a href="#print_flag_counts-723"><span class="linenos">723</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with survey data. </span>
</span><span id="print_flag_counts-724"><a href="#print_flag_counts-724"><span class="linenos">724</span></a><span class="sd">        params_sheet (str) : Excel sheet name with flag information (&#39;flags&#39;).</span>
</span><span id="print_flag_counts-725"><a href="#print_flag_counts-725"><span class="linenos">725</span></a><span class="sd">            Must contain columns &#39;flag_name&#39;, &#39;method_name&#39;, &#39;flag_group&#39;, &#39;use_flag&#39;, &#39;parameters&#39;.</span>
</span><span id="print_flag_counts-726"><a href="#print_flag_counts-726"><span class="linenos">726</span></a>
</span><span id="print_flag_counts-727"><a href="#print_flag_counts-727"><span class="linenos">727</span></a><span class="sd">    Returns:</span>
</span><span id="print_flag_counts-728"><a href="#print_flag_counts-728"><span class="linenos">728</span></a><span class="sd">        None : This function prints response classification counts. </span>
</span><span id="print_flag_counts-729"><a href="#print_flag_counts-729"><span class="linenos">729</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="print_flag_counts-730"><a href="#print_flag_counts-730"><span class="linenos">730</span></a>    <span class="c1">## Reading flag parameters</span>
</span><span id="print_flag_counts-731"><a href="#print_flag_counts-731"><span class="linenos">731</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">params_sheet</span><span class="p">)</span>
</span><span id="print_flag_counts-732"><a href="#print_flag_counts-732"><span class="linenos">732</span></a>    <span class="c1"># Verify necessary columns</span>
</span><span id="print_flag_counts-733"><a href="#print_flag_counts-733"><span class="linenos">733</span></a>    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">,</span> <span class="s1">&#39;method_name&#39;</span><span class="p">,</span> <span class="s1">&#39;flag_group&#39;</span><span class="p">,</span> <span class="s1">&#39;use_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
</span><span id="print_flag_counts-734"><a href="#print_flag_counts-734"><span class="linenos">734</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="print_flag_counts-735"><a href="#print_flag_counts-735"><span class="linenos">735</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="print_flag_counts-736"><a href="#print_flag_counts-736"><span class="linenos">736</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns in sheet &#39;</span><span class="si">{</span><span class="n">params_sheet</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="print_flag_counts-737"><a href="#print_flag_counts-737"><span class="linenos">737</span></a>    <span class="c1"># Drop inactive flags</span>
</span><span id="print_flag_counts-738"><a href="#print_flag_counts-738"><span class="linenos">738</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;use_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> 
</span><span id="print_flag_counts-739"><a href="#print_flag_counts-739"><span class="linenos">739</span></a>
</span><span id="print_flag_counts-740"><a href="#print_flag_counts-740"><span class="linenos">740</span></a>    <span class="n">flags</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="print_flag_counts-741"><a href="#print_flag_counts-741"><span class="linenos">741</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of unique responses flagged: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Total rows with at least one flag</span>
</span><span id="print_flag_counts-742"><a href="#print_flag_counts-742"><span class="linenos">742</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flags:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Table of flag counts</span>
</span><span id="print_flag_counts-743"><a href="#print_flag_counts-743"><span class="linenos">743</span></a>
</span><span id="print_flag_counts-744"><a href="#print_flag_counts-744"><span class="linenos">744</span></a>    <span class="n">flag_groups</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="print_flag_counts-745"><a href="#print_flag_counts-745"><span class="linenos">745</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flag Groups:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">flag_groups</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Table of flag group counts</span>
</span><span id="print_flag_counts-746"><a href="#print_flag_counts-746"><span class="linenos">746</span></a>
</span><span id="print_flag_counts-747"><a href="#print_flag_counts-747"><span class="linenos">747</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Prints out simple counts of flags and flag groups. </p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with survey data. </li>
<li><strong>params_sheet (str) :</strong>  Excel sheet name with flag information ('flags').
Must contain columns 'flag_name', 'method_name', 'flag_group', 'use_flag', 'parameters'.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None : This function prints response classification counts.</p>
</blockquote>
</div>


                </section>
                <section id="print_classification_counts">
                            <input id="print_classification_counts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_classification_counts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">flag_column</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="print_classification_counts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#print_classification_counts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="print_classification_counts-749"><a href="#print_classification_counts-749"><span class="linenos">749</span></a><span class="k">def</span><span class="w"> </span><span class="nf">print_classification_counts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_column</span><span class="p">):</span>
</span><span id="print_classification_counts-750"><a href="#print_classification_counts-750"><span class="linenos">750</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="print_classification_counts-751"><a href="#print_classification_counts-751"><span class="linenos">751</span></a><span class="sd">    Prints out simple counts of flags and flag groups. </span>
</span><span id="print_classification_counts-752"><a href="#print_classification_counts-752"><span class="linenos">752</span></a>
</span><span id="print_classification_counts-753"><a href="#print_classification_counts-753"><span class="linenos">753</span></a><span class="sd">    Parameters:</span>
</span><span id="print_classification_counts-754"><a href="#print_classification_counts-754"><span class="linenos">754</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with survey data. </span>
</span><span id="print_classification_counts-755"><a href="#print_classification_counts-755"><span class="linenos">755</span></a><span class="sd">        flag_column (str) : Column name for the flag classification. </span>
</span><span id="print_classification_counts-756"><a href="#print_classification_counts-756"><span class="linenos">756</span></a><span class="sd">            &#39;FLAG&#39; for algorithmic flags, &#39;MANUAL_FLAG&#39; for manual check flags, &#39;FINAL_FLAG&#39; for combined flags. </span>
</span><span id="print_classification_counts-757"><a href="#print_classification_counts-757"><span class="linenos">757</span></a>
</span><span id="print_classification_counts-758"><a href="#print_classification_counts-758"><span class="linenos">758</span></a><span class="sd">    Returns:</span>
</span><span id="print_classification_counts-759"><a href="#print_classification_counts-759"><span class="linenos">759</span></a><span class="sd">        None : This function prints flag counts and flag group counts. </span>
</span><span id="print_classification_counts-760"><a href="#print_classification_counts-760"><span class="linenos">760</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="print_classification_counts-761"><a href="#print_classification_counts-761"><span class="linenos">761</span></a>
</span><span id="print_classification_counts-762"><a href="#print_classification_counts-762"><span class="linenos">762</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response classification: </span><span class="si">{</span><span class="n">flag_column</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">flag_column</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="print_classification_counts-763"><a href="#print_classification_counts-763"><span class="linenos">763</span></a>
</span><span id="print_classification_counts-764"><a href="#print_classification_counts-764"><span class="linenos">764</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Prints out simple counts of flags and flag groups. </p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with survey data. </li>
<li><strong>flag_column (str) :</strong>  Column name for the flag classification. 
'FLAG' for algorithmic flags, 'MANUAL_FLAG' for manual check flags, 'FINAL_FLAG' for combined flags. </li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None : This function prints flag counts and flag group counts.</p>
</blockquote>
</div>


                </section>
                <section id="plot_flag_cooccurrence_heatmap">
                            <input id="plot_flag_cooccurrence_heatmap-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_flag_cooccurrence_heatmap</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">flag_columns</span>,</span><span class="param">	<span class="n">params_sheet</span>,</span><span class="param">	<span class="n">use_groups</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">save_folder</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">display_figure</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_flag_cooccurrence_heatmap-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_flag_cooccurrence_heatmap"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_flag_cooccurrence_heatmap-766"><a href="#plot_flag_cooccurrence_heatmap-766"><span class="linenos">766</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_flag_cooccurrence_heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flag_columns</span><span class="p">,</span>
</span><span id="plot_flag_cooccurrence_heatmap-767"><a href="#plot_flag_cooccurrence_heatmap-767"><span class="linenos">767</span></a>                                  <span class="n">params_sheet</span><span class="p">,</span>
</span><span id="plot_flag_cooccurrence_heatmap-768"><a href="#plot_flag_cooccurrence_heatmap-768"><span class="linenos">768</span></a>                                  <span class="n">use_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="plot_flag_cooccurrence_heatmap-769"><a href="#plot_flag_cooccurrence_heatmap-769"><span class="linenos">769</span></a>                                  <span class="n">save_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="plot_flag_cooccurrence_heatmap-770"><a href="#plot_flag_cooccurrence_heatmap-770"><span class="linenos">770</span></a>                                  <span class="n">display_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="plot_flag_cooccurrence_heatmap-771"><a href="#plot_flag_cooccurrence_heatmap-771"><span class="linenos">771</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_flag_cooccurrence_heatmap-772"><a href="#plot_flag_cooccurrence_heatmap-772"><span class="linenos">772</span></a><span class="sd">    Plots a square heatmap of co-occurrence between flags (or flag groups) and the response classification.</span>
</span><span id="plot_flag_cooccurrence_heatmap-773"><a href="#plot_flag_cooccurrence_heatmap-773"><span class="linenos">773</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-774"><a href="#plot_flag_cooccurrence_heatmap-774"><span class="linenos">774</span></a><span class="sd">    Parameters:</span>
</span><span id="plot_flag_cooccurrence_heatmap-775"><a href="#plot_flag_cooccurrence_heatmap-775"><span class="linenos">775</span></a><span class="sd">        df (pd.DataFrame) : Dataframe with survey data and flags.</span>
</span><span id="plot_flag_cooccurrence_heatmap-776"><a href="#plot_flag_cooccurrence_heatmap-776"><span class="linenos">776</span></a><span class="sd">        flag_columns (List[str]) : Column names containing the classification (e.g., &#39;FLAG&#39;, &#39;MANUAL_FLAG&#39;, or &#39;FINAL_FLAG&#39;).</span>
</span><span id="plot_flag_cooccurrence_heatmap-777"><a href="#plot_flag_cooccurrence_heatmap-777"><span class="linenos">777</span></a><span class="sd">        params_sheet (str) : Excel sheet name with flag information (&#39;flags&#39;).</span>
</span><span id="plot_flag_cooccurrence_heatmap-778"><a href="#plot_flag_cooccurrence_heatmap-778"><span class="linenos">778</span></a><span class="sd">            Must contain columns &#39;flag_name&#39;, &#39;method_name&#39;, &#39;flag_group&#39;, &#39;use_flag&#39;, &#39;parameters&#39;.</span>
</span><span id="plot_flag_cooccurrence_heatmap-779"><a href="#plot_flag_cooccurrence_heatmap-779"><span class="linenos">779</span></a><span class="sd">        use_groups (bool) : If True, use flag groups instead of individual flags.</span>
</span><span id="plot_flag_cooccurrence_heatmap-780"><a href="#plot_flag_cooccurrence_heatmap-780"><span class="linenos">780</span></a><span class="sd">        save_folder (str) : Optional folder path to save the heatmap.</span>
</span><span id="plot_flag_cooccurrence_heatmap-781"><a href="#plot_flag_cooccurrence_heatmap-781"><span class="linenos">781</span></a><span class="sd">        display_figure (bool) : If True, display created figures. Defaults to True.</span>
</span><span id="plot_flag_cooccurrence_heatmap-782"><a href="#plot_flag_cooccurrence_heatmap-782"><span class="linenos">782</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-783"><a href="#plot_flag_cooccurrence_heatmap-783"><span class="linenos">783</span></a><span class="sd">    Returns:</span>
</span><span id="plot_flag_cooccurrence_heatmap-784"><a href="#plot_flag_cooccurrence_heatmap-784"><span class="linenos">784</span></a><span class="sd">        None : Displays a seaborn heatmap.</span>
</span><span id="plot_flag_cooccurrence_heatmap-785"><a href="#plot_flag_cooccurrence_heatmap-785"><span class="linenos">785</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_flag_cooccurrence_heatmap-786"><a href="#plot_flag_cooccurrence_heatmap-786"><span class="linenos">786</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
</span><span id="plot_flag_cooccurrence_heatmap-787"><a href="#plot_flag_cooccurrence_heatmap-787"><span class="linenos">787</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="plot_flag_cooccurrence_heatmap-788"><a href="#plot_flag_cooccurrence_heatmap-788"><span class="linenos">788</span></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ticker</span>
</span><span id="plot_flag_cooccurrence_heatmap-789"><a href="#plot_flag_cooccurrence_heatmap-789"><span class="linenos">789</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>
</span><span id="plot_flag_cooccurrence_heatmap-790"><a href="#plot_flag_cooccurrence_heatmap-790"><span class="linenos">790</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-791"><a href="#plot_flag_cooccurrence_heatmap-791"><span class="linenos">791</span></a>    <span class="c1">## Reading classification rule parameters</span>
</span><span id="plot_flag_cooccurrence_heatmap-792"><a href="#plot_flag_cooccurrence_heatmap-792"><span class="linenos">792</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">read_parameters_sheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">params_sheet</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-793"><a href="#plot_flag_cooccurrence_heatmap-793"><span class="linenos">793</span></a>    <span class="c1"># Verify necessary columns</span>
</span><span id="plot_flag_cooccurrence_heatmap-794"><a href="#plot_flag_cooccurrence_heatmap-794"><span class="linenos">794</span></a>    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">,</span> <span class="s1">&#39;method_name&#39;</span><span class="p">,</span> <span class="s1">&#39;flag_group&#39;</span><span class="p">,</span> <span class="s1">&#39;use_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
</span><span id="plot_flag_cooccurrence_heatmap-795"><a href="#plot_flag_cooccurrence_heatmap-795"><span class="linenos">795</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="plot_flag_cooccurrence_heatmap-796"><a href="#plot_flag_cooccurrence_heatmap-796"><span class="linenos">796</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="plot_flag_cooccurrence_heatmap-797"><a href="#plot_flag_cooccurrence_heatmap-797"><span class="linenos">797</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns in sheet &#39;</span><span class="si">{</span><span class="n">params_sheet</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-798"><a href="#plot_flag_cooccurrence_heatmap-798"><span class="linenos">798</span></a>    <span class="c1"># Drop inactive flags</span>
</span><span id="plot_flag_cooccurrence_heatmap-799"><a href="#plot_flag_cooccurrence_heatmap-799"><span class="linenos">799</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;use_flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> 
</span><span id="plot_flag_cooccurrence_heatmap-800"><a href="#plot_flag_cooccurrence_heatmap-800"><span class="linenos">800</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-801"><a href="#plot_flag_cooccurrence_heatmap-801"><span class="linenos">801</span></a>    <span class="c1"># Identify relevant flag columns</span>
</span><span id="plot_flag_cooccurrence_heatmap-802"><a href="#plot_flag_cooccurrence_heatmap-802"><span class="linenos">802</span></a>    <span class="n">column_key</span> <span class="o">=</span> <span class="s1">&#39;flag_group&#39;</span> <span class="k">if</span> <span class="n">use_groups</span> <span class="k">else</span> <span class="s1">&#39;flag_name&#39;</span>
</span><span id="plot_flag_cooccurrence_heatmap-803"><a href="#plot_flag_cooccurrence_heatmap-803"><span class="linenos">803</span></a>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="n">column_key</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="plot_flag_cooccurrence_heatmap-804"><a href="#plot_flag_cooccurrence_heatmap-804"><span class="linenos">804</span></a>    
</span><span id="plot_flag_cooccurrence_heatmap-805"><a href="#plot_flag_cooccurrence_heatmap-805"><span class="linenos">805</span></a>    <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">flag_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="plot_flag_cooccurrence_heatmap-806"><a href="#plot_flag_cooccurrence_heatmap-806"><span class="linenos">806</span></a>    <span class="k">if</span> <span class="n">missing_cols</span><span class="p">:</span>
</span><span id="plot_flag_cooccurrence_heatmap-807"><a href="#plot_flag_cooccurrence_heatmap-807"><span class="linenos">807</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing column(s) in DataFrame: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-808"><a href="#plot_flag_cooccurrence_heatmap-808"><span class="linenos">808</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-809"><a href="#plot_flag_cooccurrence_heatmap-809"><span class="linenos">809</span></a>    <span class="c1"># Binary matrix for classifications</span>
</span><span id="plot_flag_cooccurrence_heatmap-810"><a href="#plot_flag_cooccurrence_heatmap-810"><span class="linenos">810</span></a>    <span class="n">classification_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">flag_columns</span><span class="p">])</span>
</span><span id="plot_flag_cooccurrence_heatmap-811"><a href="#plot_flag_cooccurrence_heatmap-811"><span class="linenos">811</span></a>    <span class="n">classification_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_flag_cooccurrence_heatmap-812"><a href="#plot_flag_cooccurrence_heatmap-812"><span class="linenos">812</span></a>        <span class="n">classification_dummies</span>
</span><span id="plot_flag_cooccurrence_heatmap-813"><a href="#plot_flag_cooccurrence_heatmap-813"><span class="linenos">813</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-814"><a href="#plot_flag_cooccurrence_heatmap-814"><span class="linenos">814</span></a>        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-815"><a href="#plot_flag_cooccurrence_heatmap-815"><span class="linenos">815</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-816"><a href="#plot_flag_cooccurrence_heatmap-816"><span class="linenos">816</span></a>    <span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-817"><a href="#plot_flag_cooccurrence_heatmap-817"><span class="linenos">817</span></a>    <span class="n">flag_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_flag_cooccurrence_heatmap-818"><a href="#plot_flag_cooccurrence_heatmap-818"><span class="linenos">818</span></a>        <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
</span><span id="plot_flag_cooccurrence_heatmap-819"><a href="#plot_flag_cooccurrence_heatmap-819"><span class="linenos">819</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-820"><a href="#plot_flag_cooccurrence_heatmap-820"><span class="linenos">820</span></a>        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-821"><a href="#plot_flag_cooccurrence_heatmap-821"><span class="linenos">821</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-822"><a href="#plot_flag_cooccurrence_heatmap-822"><span class="linenos">822</span></a>    <span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-823"><a href="#plot_flag_cooccurrence_heatmap-823"><span class="linenos">823</span></a>    <span class="c1"># Combine and compute co-occurrence matrix</span>
</span><span id="plot_flag_cooccurrence_heatmap-824"><a href="#plot_flag_cooccurrence_heatmap-824"><span class="linenos">824</span></a>    <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">flag_df</span><span class="p">,</span> <span class="n">classification_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-825"><a href="#plot_flag_cooccurrence_heatmap-825"><span class="linenos">825</span></a>    <span class="n">co_matrix</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">combined</span>  <span class="c1"># True count of co-occurrences (dot product)</span>
</span><span id="plot_flag_cooccurrence_heatmap-826"><a href="#plot_flag_cooccurrence_heatmap-826"><span class="linenos">826</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-827"><a href="#plot_flag_cooccurrence_heatmap-827"><span class="linenos">827</span></a>    <span class="c1"># Initialize heatmap</span>
</span><span id="plot_flag_cooccurrence_heatmap-828"><a href="#plot_flag_cooccurrence_heatmap-828"><span class="linenos">828</span></a>    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="plot_flag_cooccurrence_heatmap-829"><a href="#plot_flag_cooccurrence_heatmap-829"><span class="linenos">829</span></a>    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_matrix</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_matrix</span><span class="p">)))</span>
</span><span id="plot_flag_cooccurrence_heatmap-830"><a href="#plot_flag_cooccurrence_heatmap-830"><span class="linenos">830</span></a>    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-831"><a href="#plot_flag_cooccurrence_heatmap-831"><span class="linenos">831</span></a>    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-832"><a href="#plot_flag_cooccurrence_heatmap-832"><span class="linenos">832</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-833"><a href="#plot_flag_cooccurrence_heatmap-833"><span class="linenos">833</span></a>    <span class="n">heatmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">co_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">,</span>
</span><span id="plot_flag_cooccurrence_heatmap-834"><a href="#plot_flag_cooccurrence_heatmap-834"><span class="linenos">834</span></a>                          <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">fontsize</span><span class="p">},</span> <span class="n">cbar_ax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
</span><span id="plot_flag_cooccurrence_heatmap-835"><a href="#plot_flag_cooccurrence_heatmap-835"><span class="linenos">835</span></a>                          <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-836"><a href="#plot_flag_cooccurrence_heatmap-836"><span class="linenos">836</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-837"><a href="#plot_flag_cooccurrence_heatmap-837"><span class="linenos">837</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Co-occurrence of </span><span class="si">{</span><span class="s1">&#39;Flag Groups&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">use_groups</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Flags&#39;</span><span class="si">}</span><span class="s2"> and classified responses (</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flag_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-838"><a href="#plot_flag_cooccurrence_heatmap-838"><span class="linenos">838</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-839"><a href="#plot_flag_cooccurrence_heatmap-839"><span class="linenos">839</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-840"><a href="#plot_flag_cooccurrence_heatmap-840"><span class="linenos">840</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span> <span class="c1"># Square heatmap</span>
</span><span id="plot_flag_cooccurrence_heatmap-841"><a href="#plot_flag_cooccurrence_heatmap-841"><span class="linenos">841</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-842"><a href="#plot_flag_cooccurrence_heatmap-842"><span class="linenos">842</span></a>    <span class="c1"># Force colorbar ticks to be integers</span>
</span><span id="plot_flag_cooccurrence_heatmap-843"><a href="#plot_flag_cooccurrence_heatmap-843"><span class="linenos">843</span></a>    <span class="n">cbar</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
</span><span id="plot_flag_cooccurrence_heatmap-844"><a href="#plot_flag_cooccurrence_heatmap-844"><span class="linenos">844</span></a>    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="plot_flag_cooccurrence_heatmap-845"><a href="#plot_flag_cooccurrence_heatmap-845"><span class="linenos">845</span></a>    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-846"><a href="#plot_flag_cooccurrence_heatmap-846"><span class="linenos">846</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-847"><a href="#plot_flag_cooccurrence_heatmap-847"><span class="linenos">847</span></a>    <span class="c1"># Prepare group boundaries for visual separation</span>
</span><span id="plot_flag_cooccurrence_heatmap-848"><a href="#plot_flag_cooccurrence_heatmap-848"><span class="linenos">848</span></a>    <span class="k">if</span> <span class="n">use_groups</span><span class="p">:</span>
</span><span id="plot_flag_cooccurrence_heatmap-849"><a href="#plot_flag_cooccurrence_heatmap-849"><span class="linenos">849</span></a>        <span class="n">df_flags</span> <span class="o">=</span> <span class="n">params</span><span class="p">[[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-850"><a href="#plot_flag_cooccurrence_heatmap-850"><span class="linenos">850</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="plot_flag_cooccurrence_heatmap-851"><a href="#plot_flag_cooccurrence_heatmap-851"><span class="linenos">851</span></a>        <span class="n">df_flags</span> <span class="o">=</span> <span class="n">params</span><span class="p">[[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">,</span> <span class="s1">&#39;flag_group&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;EMPTY&#39;</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-852"><a href="#plot_flag_cooccurrence_heatmap-852"><span class="linenos">852</span></a>        <span class="n">df_flags</span> <span class="o">=</span> <span class="n">df_flags</span><span class="p">[</span><span class="n">df_flags</span><span class="p">[</span><span class="s1">&#39;flag_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">columns</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-853"><a href="#plot_flag_cooccurrence_heatmap-853"><span class="linenos">853</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-854"><a href="#plot_flag_cooccurrence_heatmap-854"><span class="linenos">854</span></a>    <span class="n">group_boundaries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="plot_flag_cooccurrence_heatmap-855"><a href="#plot_flag_cooccurrence_heatmap-855"><span class="linenos">855</span></a>    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_flags</span><span class="p">[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
</span><span id="plot_flag_cooccurrence_heatmap-856"><a href="#plot_flag_cooccurrence_heatmap-856"><span class="linenos">856</span></a>        <span class="n">max_index</span> <span class="o">=</span> <span class="n">df_flags</span><span class="p">[</span><span class="n">df_flags</span><span class="p">[</span><span class="s1">&#39;flag_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="plot_flag_cooccurrence_heatmap-857"><a href="#plot_flag_cooccurrence_heatmap-857"><span class="linenos">857</span></a>        <span class="n">group_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_index</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-858"><a href="#plot_flag_cooccurrence_heatmap-858"><span class="linenos">858</span></a>    <span class="n">group_boundaries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">group_boundaries</span><span class="p">))</span>
</span><span id="plot_flag_cooccurrence_heatmap-859"><a href="#plot_flag_cooccurrence_heatmap-859"><span class="linenos">859</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-860"><a href="#plot_flag_cooccurrence_heatmap-860"><span class="linenos">860</span></a>    <span class="c1"># Draw visual borders</span>
</span><span id="plot_flag_cooccurrence_heatmap-861"><a href="#plot_flag_cooccurrence_heatmap-861"><span class="linenos">861</span></a>    <span class="n">flag_end_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="plot_flag_cooccurrence_heatmap-862"><a href="#plot_flag_cooccurrence_heatmap-862"><span class="linenos">862</span></a>    <span class="n">total_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_matrix</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-863"><a href="#plot_flag_cooccurrence_heatmap-863"><span class="linenos">863</span></a>    <span class="c1"># Starting border (left and top)</span>
</span><span id="plot_flag_cooccurrence_heatmap-864"><a href="#plot_flag_cooccurrence_heatmap-864"><span class="linenos">864</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-865"><a href="#plot_flag_cooccurrence_heatmap-865"><span class="linenos">865</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-866"><a href="#plot_flag_cooccurrence_heatmap-866"><span class="linenos">866</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-867"><a href="#plot_flag_cooccurrence_heatmap-867"><span class="linenos">867</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_groups</span><span class="p">:</span>
</span><span id="plot_flag_cooccurrence_heatmap-868"><a href="#plot_flag_cooccurrence_heatmap-868"><span class="linenos">868</span></a>        <span class="k">for</span> <span class="n">boundary</span> <span class="ow">in</span> <span class="n">group_boundaries</span><span class="p">:</span>
</span><span id="plot_flag_cooccurrence_heatmap-869"><a href="#plot_flag_cooccurrence_heatmap-869"><span class="linenos">869</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">boundary</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-870"><a href="#plot_flag_cooccurrence_heatmap-870"><span class="linenos">870</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">boundary</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-871"><a href="#plot_flag_cooccurrence_heatmap-871"><span class="linenos">871</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-872"><a href="#plot_flag_cooccurrence_heatmap-872"><span class="linenos">872</span></a>    <span class="c1"># Classfication border</span>
</span><span id="plot_flag_cooccurrence_heatmap-873"><a href="#plot_flag_cooccurrence_heatmap-873"><span class="linenos">873</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">flag_end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-874"><a href="#plot_flag_cooccurrence_heatmap-874"><span class="linenos">874</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">flag_end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-875"><a href="#plot_flag_cooccurrence_heatmap-875"><span class="linenos">875</span></a>    <span class="c1"># Ending border (right and bottom)</span>
</span><span id="plot_flag_cooccurrence_heatmap-876"><a href="#plot_flag_cooccurrence_heatmap-876"><span class="linenos">876</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">total_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-877"><a href="#plot_flag_cooccurrence_heatmap-877"><span class="linenos">877</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">total_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-878"><a href="#plot_flag_cooccurrence_heatmap-878"><span class="linenos">878</span></a>
</span><span id="plot_flag_cooccurrence_heatmap-879"><a href="#plot_flag_cooccurrence_heatmap-879"><span class="linenos">879</span></a>    <span class="c1"># Save and Display</span>
</span><span id="plot_flag_cooccurrence_heatmap-880"><a href="#plot_flag_cooccurrence_heatmap-880"><span class="linenos">880</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_flag_cooccurrence_heatmap-881"><a href="#plot_flag_cooccurrence_heatmap-881"><span class="linenos">881</span></a>    <span class="k">if</span> <span class="n">save_folder</span><span class="p">:</span>
</span><span id="plot_flag_cooccurrence_heatmap-882"><a href="#plot_flag_cooccurrence_heatmap-882"><span class="linenos">882</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_folder</span><span class="p">):</span>
</span><span id="plot_flag_cooccurrence_heatmap-883"><a href="#plot_flag_cooccurrence_heatmap-883"><span class="linenos">883</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The folder path </span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-884"><a href="#plot_flag_cooccurrence_heatmap-884"><span class="linenos">884</span></a>        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;FG&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">use_groups</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;F&#39;</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flag_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-885"><a href="#plot_flag_cooccurrence_heatmap-885"><span class="linenos">885</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="plot_flag_cooccurrence_heatmap-886"><a href="#plot_flag_cooccurrence_heatmap-886"><span class="linenos">886</span></a>    <span class="k">if</span> <span class="n">display_figure</span><span class="p">:</span>
</span><span id="plot_flag_cooccurrence_heatmap-887"><a href="#plot_flag_cooccurrence_heatmap-887"><span class="linenos">887</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plots a square heatmap of co-occurrence between flags (or flag groups) and the response classification.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>df (pd.DataFrame) :</strong>  Dataframe with survey data and flags.</li>
<li><strong>flag_columns (List[str]) :</strong>  Column names containing the classification (e.g., 'FLAG', 'MANUAL_FLAG', or 'FINAL_FLAG').</li>
<li><strong>params_sheet (str) :</strong>  Excel sheet name with flag information ('flags').
Must contain columns 'flag_name', 'method_name', 'flag_group', 'use_flag', 'parameters'.</li>
<li><strong>use_groups (bool) :</strong>  If True, use flag groups instead of individual flags.</li>
<li><strong>save_folder (str) :</strong>  Optional folder path to save the heatmap.</li>
<li><strong>display_figure (bool) :</strong>  If True, display created figures. Defaults to True.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None : Displays a seaborn heatmap.</p>
</blockquote>
</div>


                </section>
    </main>
</body>
</html>